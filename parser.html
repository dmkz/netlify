<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Парсер боёв HeroesWM</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 16px;
      margin-bottom: 20px;
    }
    pre {
      background-color: #f4f4f4;
      padding: 15px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Парсер боёв HeroesWM</h1>
  <p>Вставьте текст с записями боёв (любого формата):</p>
  <textarea id="inputText" rows="12" placeholder="Например:
73)https://www.heroeswm.ru/war.php?warid=1547755596&show=NHKOVn6B
15498, разбой
74)https://my.lordswm.com/warlog.php?warid=1547758771&show=NoD0xiiZ
15498, гном"></textarea>
  <br>
  <button id="processBtn">Обработать!</button>
  
  <h2>Результаты</h2>
  <pre id="result"></pre>
  
  <script>
    // Функция для обработки одного URL боя
    async function processBattle(urlStr) {
      let urlObj;
      try {
        // Извлекаем URL из строки – ищем шаблон, где домен и путь могут быть разными
        const urlMatch = urlStr.match(/https?:\/\/(?:www\.)?(heroeswm\.ru|my\.lordswm\.com|lordswm\.com)\/(?:war\.php|warlog\.php)\?\S*/i);
        if (!urlMatch) throw new Error("URL не найден");
        urlObj = new URL(urlMatch[0]);
      } catch (e) {
        return { error: "Неверный формат URL", url: urlStr };
      }
      
      // Извлекаем параметры: warid и show_for_all (или show)
      const warid = urlObj.searchParams.get('warid');
      let show_for_all = urlObj.searchParams.get('show_for_all') || urlObj.searchParams.get('show');
      if (!warid || !show_for_all) {
        return { error: "Отсутствуют параметры warid/show_for_all", url: urlStr };
      }
      
      // Формируем URL запроса к прокси‑функции
      // Прокси функция всегда обращается к https://www.heroeswm.ru/battle.php
      const proxyUrl = `/.netlify/functions/parse-battle?warid=${encodeURIComponent(warid)}&show_for_all=${encodeURIComponent(show_for_all)}`;
      
      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) {
          return { error: `Ошибка запроса: ${response.status} ${response.statusText}`, url: urlStr };
        }
        const html = await response.text();
        
        // Ищем подстроку между "К вам присоединились новые отряды: " и "<br />"
        const startStr = "К вам присоединились новые отряды: ";
        const endStr = "<br />";
        const startIndex = html.indexOf(startStr);
        let extracted = "";
        if (startIndex !== -1) {
          const substringStart = startIndex + startStr.length;
          const endIndex = html.indexOf(endStr, substringStart);
          if (endIndex !== -1) {
            extracted = html.substring(substringStart, endIndex).trim();
          }
        }
        if (!extracted) {
          extracted = "слив";
        }
        return { result: extracted, url: urlStr };
      } catch (error) {
        return { error: error.toString(), url: urlStr };
      }
    }
    
    document.getElementById('processBtn').addEventListener('click', async function() {
      const inputText = document.getElementById('inputText').value.trim();
      if (!inputText) {
         alert('Пожалуйста, введите текст');
         return;
      }
      
      const resultElem = document.getElementById('result');
      resultElem.textContent = "Обработка...\n";
      
      // Разбиваем весь ввод на строки
      const lines = inputText.split(/\r?\n/);
      
      // Массив для результатов
      let outputLines = [];
      
      // Для каждой строки ищем URL, удовлетворяющий нужному шаблону
      for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;
        
        // Ищем URL, который начинается с http/https и содержит один из нужных доменов и нужный путь
        const regex = /https?:\/\/(?:www\.)?(heroeswm\.ru|my\.lordswm\.com|lordswm\.com)\/(?:war\.php|warlog\.php)\?\S*/i;
        if (regex.test(trimmedLine)) {
          resultElem.textContent += `Обработка: ${trimmedLine}\n`;
          const battleResult = await processBattle(trimmedLine);
          if (battleResult.error) {
            outputLines.push(`${battleResult.error}, ${battleResult.url}`);
          } else {
            outputLines.push(`${battleResult.result}, ${battleResult.url}`);
          }
        }
      }
      
      // Выводим итоговый результат
      resultElem.textContent = outputLines.join("\n");
    });
  </script>
</body>
</html>
