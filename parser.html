<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HeroesWM Battle Result Extractor</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    iframe { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>
  <!-- Вставляем страницу боя в iframe -->
  <iframe id="warFrame" src="https://www.heroeswm.ru/war.php?warid=1546342792&show=NeOttY_q"></iframe>
  
  <script>
    // Функция ожидания, пока условие не станет истинным или не истечёт таймаут
    function waitFor(conditionFn, timeout = 30000, interval = 500) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        const timer = setInterval(() => {
          try {
            if (conditionFn()) {
              clearInterval(timer);
              resolve();
            } else if (Date.now() - start > timeout) {
              clearInterval(timer);
              reject(new Error("Timeout waiting for condition"));
            }
          } catch (e) {
            // Если возникла ошибка доступа (например, из-за same origin policy), можно её обработать здесь
            console.error(e);
          }
        }, interval);
      });
    }
    
    // Когда iframe загрузится, начинаем работу
    document.getElementById('warFrame').addEventListener('load', async function() {
      try {
        // Попытка доступа к документу внутри iframe (будет работать только при разрешённом доступе)
        const warDoc = this.contentDocument || this.contentWindow.document;
        
        // Ждем, пока кнопка с id "confirm_ins" станет видимой
        await waitFor(() => {
          const btn = warDoc.getElementById('confirm_ins');
          return btn && getComputedStyle(btn).display !== 'none';
        });
        const btn = warDoc.getElementById('confirm_ins');
        console.log("Кнопка обнаружена и стала видимой. Нажимаем её.");
        btn.click();
        
        // Ждем, пока элемент с результатом боя заполнится текстом.
        await waitFor(() => {
          const resultElem = warDoc.getElementById('finalresult_text');
          return resultElem && resultElem.innerText.trim().length > 0;
        });
        const resultElem = warDoc.getElementById('finalresult_text');
        console.log("Результат боя:", resultElem.innerText);
      } catch (e) {
        console.error("Ошибка:", e);
      }
    });
  </script>
</body>
</html>
