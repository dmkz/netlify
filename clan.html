<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Администрирование тех. клана</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    .field { flex: 1; min-width: 300px; }
    textarea { width: 100%; height: 200px; font-family: monospace; }
    button { padding: 10px 20px; font-size: 16px; }
    .collapsible { margin-bottom: 10px; border: 1px solid #ccc; }
    .collapsible-header { background-color: #f0f0f0; padding: 5px; cursor: pointer; }
    .collapsible-list { margin: 0; padding: 5px; }
    table { width: 100%; border-collapse: collapse; }
    td { padding: 5px; border-bottom: 1px solid #ccc; }
    td a { text-decoration: none; color: blue; }
    td a:hover { text-decoration: underline; }
    .remove-button { color: red; border: none; background: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Администрирование тех. клана</h1>
  <div class="container">
    <div class="field">
      <h3>Технические кланы<br/>(ID, по одному в строке)</h3>
      <textarea id="techClans"></textarea>
    </div>
    <div class="field">
      <h3>Боевые кланы<br/>(ID, по одному в строке)</h3>
      <textarea id="battleClans"></textarea>
    </div>
    <div class="field">
      <h3>Особенные игроки<br/>(ID, по одному в строке)</h3>
      <textarea id="excludePlayers"></textarea>
    </div>
  </div>
  <button id="processBtn">Обработать</button>
  <h2>Результаты:</h2>
  <div id="results"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('clan.html loaded');

      // Функция для создания таблицы с игроками
      function createPlayerTable(items, groupType) {
        const table = document.createElement('table');
        items.forEach(item => {
          const tr = document.createElement('tr');

          // Столбец с id (кликабельная ссылка)
          const tdId = document.createElement('td');
          const aId = document.createElement('a');
          aId.href = `https://www.heroeswm.ru/pl_info.php?id=${item.id}`;
          aId.target = '_blank';
          aId.textContent = item.id;
          tdId.appendChild(aId);
          tr.appendChild(tdId);

          // Столбец с никнеймом (кликабельная ссылка)
          const tdName = document.createElement('td');
          const aName = document.createElement('a');
          aName.href = `https://www.heroeswm.ru/pl_info.php?id=${item.id}`;
          aName.target = '_blank';
          aName.textContent = item.name;
          tdName.appendChild(aName);
          tr.appendChild(tdName);

          // Если группа "enemy", выводим дополнительную информацию о клане, иначе пустой столбец
          const tdClan = document.createElement('td');
          if (groupType === 'enemy' && item.joinedClanId) {
            tdClan.textContent = `${item.joinedClanId} - ${item.joinedClanName}`;
          }
          tr.appendChild(tdClan);

          // Столбец с кнопкой красного крестика
          const tdButton = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '✖';
          btn.classList.add('remove-button');
          btn.addEventListener('click', () => {
            // Добавляем id игрока в список исключений, если его там ещё нет.
            const excludeTextarea = document.getElementById('excludePlayers');
            let currentExcludes = excludeTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (!currentExcludes.includes(item.id)) {
              currentExcludes.push(item.id);
              excludeTextarea.value = currentExcludes.join('\n');
              localStorage.setItem('excludePlayers', excludeTextarea.value);
            }
            // Удаляем строку из таблицы
            tr.remove();
            // Обновляем заголовок таблицы (если нужно, уменьшив количество элементов)
          });
          tdButton.appendChild(btn);
          tr.appendChild(tdButton);

          table.appendChild(tr);
        });
        return table;
      }

      // Функция для создания сворачиваемой секции, которая выводит список игроков в виде таблицы
      function createCollapsible(title, items, groupType) {
        const container = document.createElement('div');
        container.classList.add('collapsible');

        const header = document.createElement('div');
        header.classList.add('collapsible-header');
        header.textContent = title + ' (' + items.length + ')';
        container.appendChild(header);

        const content = document.createElement('div');
        content.style.display = 'none';
        const table = createPlayerTable(items, groupType);
        content.appendChild(table);
        container.appendChild(content);

        header.addEventListener('click', () => {
          content.style.display = content.style.display === 'none' ? 'block' : 'none';
        });
        return container;
      }

      // Функция для создания группированного сворачиваемого списка
      function createGroupedCollapsible(groupedData, title) {
        const container = document.createElement('div');
        container.classList.add('collapsible');

        // Подсчитываем суммарное количество игроков во всех группах
        let totalCount = 0;
        Object.values(groupedData).forEach(group => {
          totalCount += group.players.length;
        });

        const header = document.createElement('div');
        header.classList.add('collapsible-header');
        header.textContent = title + ' (' + totalCount + ')';
        container.appendChild(header);

        const content = document.createElement('div');
        content.style.display = 'none';
        Object.keys(groupedData).forEach(key => {
          const group = groupedData[key];
          const groupCollapsible = createCollapsible(`${key} - ${group.clanName}`, group.players, groupType='invite');
          content.appendChild(groupCollapsible);
        });
        container.appendChild(content);

        header.addEventListener('click', () => {
          content.style.display = content.style.display === 'none' ? 'block' : 'none';
        });
        return container;
      }

      function renderResults(data) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        data.forEach(clan => {
          const clanContainer = document.createElement('div');
          clanContainer.style.marginBottom = '20px';

          // Если techClanName уже содержит идентификатор, выводим только название
          const title = document.createElement('h3');
          if (clan.techClanName.includes(clan.techClanId)) {
            title.textContent = clan.techClanName;
          } else {
            title.textContent = `Клан ${clan.techClanId} - ${clan.techClanName}`;
          }
          clanContainer.appendChild(title);

          const columns = document.createElement('div');
          columns.style.display = 'flex';
          columns.style.gap = '10px';

          // Пригласить: группированное сворачиваемое, заголовок "Нужно пригласить"
          const inviteCollapsible = createGroupedCollapsible(clan.inviteGroups, 'Нужно пригласить');
          // Ушёл во вражеские кланы: группированное сворачиваемое, заголовок "Ушёл во вражеские кланы"
          const enemyCollapsible = createGroupedCollapsible(clan.enemyGroups, 'Ушёл во вражеские кланы');
          // Без клана: простой сворачиваемый список
          const clanlessCollapsible = createCollapsible('Без клана', clan.clanlessList, 'clanless');

          columns.appendChild(inviteCollapsible);
          columns.appendChild(enemyCollapsible);
          columns.appendChild(clanlessCollapsible);
          clanContainer.appendChild(columns);
          resultsDiv.appendChild(clanContainer);
        });
      }

      // Функции для сохранения и загрузки значений из localStorage
      function saveField(id) {
        const value = document.getElementById(id).value;
        localStorage.setItem(id, value);
      }
      function loadField(id) {
        const value = localStorage.getItem(id);
        if (value !== null) {
          document.getElementById(id).value = value;
        }
      }

      // При загрузке страницы – восстанавливаем данные
      ['techClans', 'battleClans', 'excludePlayers'].forEach(loadField);
      const savedResults = localStorage.getItem('results');
      if (savedResults) {
        document.getElementById('results').innerHTML = savedResults;
      }

      // Сохраняем изменения при каждом вводе
      ['techClans', 'battleClans', 'excludePlayers'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => saveField(id));
      });

      document.getElementById('processBtn').addEventListener('click', async () => {
        console.log('Обработка началась');
        const techClans = document.getElementById('techClans').value;
        const battleClans = document.getElementById('battleClans').value;
        const excludePlayers = document.getElementById('excludePlayers').value;

        console.log('Отправляем данные:', { techClans, battleClans, excludePlayers });
        
        try {
          const res = await fetch('/.netlify/functions/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              techClanIds: techClans,
              battleClanIds: battleClans,
              excludePlayers: excludePlayers
            })
          });
          console.log('Ответ сервера:', res.status, res.statusText);
          if (!res.ok) {
            throw new Error(`Ошибка запроса: ${res.status} ${res.statusText}`);
          }
          const data = await res.json();
          console.log('Полученные данные:', data);
          renderResults(data);
          localStorage.setItem('results', document.getElementById('results').innerHTML);
        } catch (error) {
          console.error('Ошибка при обработке запроса:', error);
          document.getElementById('results').innerText = 'Ошибка: ' + error.message;
        }
      });
    });
  </script>
</body>
</html>
