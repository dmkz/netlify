<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Парсер форумных проходок с raw data</title>
</head>
<body>
  <h1>Парсер форумных проходок</h1>
  <input id="tid" type="text" placeholder="Введите ID темы">
  <button id="startBtn">Старт</button>
  <div id="status"></div>
  <!-- Textarea для вывода raw HTML -->
  <textarea id="rawData" rows="15" cols="100" placeholder="Raw data будет здесь"></textarea>
  <div id="results"></div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const statusDiv = document.getElementById('status');
    const rawDataTextArea = document.getElementById('rawData');
    const resultsDiv = document.getElementById('results');

    startBtn.addEventListener('click', async () => {
      const tid = document.getElementById('tid').value.trim();
      if (!tid) return alert('Укажите ID темы');

      try {
        // Получаем raw data последней страницы для определения темы и числа страниц
        const lastPageHTML = await fetchPage(tid, 'last');
        // Вывод raw HTML в textarea
        rawDataTextArea.value = lastPageHTML;

        const { title, totalPages } = parseTitleAndPages(lastPageHTML);
        statusDiv.innerHTML = `<p>Тема: <strong>${title}</strong>. Страниц: <strong>${totalPages}</strong>.</p>`;
      } catch (error) {
        alert('Ошибка получения raw data: ' + error.message);
      }
    });

    // Функция для вызова Netlify-функции и получения HTML страницы
    async function fetchPage(tid, page) {
      const res = await fetch(`/.netlify/functions/parser?tid=${tid}&page=${page}`);
      if (!res.ok) throw new Error('Ошибка сети: ' + res.status);
      return await res.text();
    }

    // Функция для парсинга названия темы и общего числа страниц из тега <title>
    function parseTitleAndPages(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const titleElement = doc.querySelector('title');
      if (!titleElement) {
        throw new Error("Элемент <title> не найден в HTML");
      }
      const titleText = titleElement.innerText;
      const titleMatch = titleText.match(/^"([^"]+)"\s+-\s+страница/);
      const pagesMatch = titleText.match(/из\s+(\d+)/);
      return {
        title: titleMatch ? titleMatch[1] : 'Неизвестная тема',
        totalPages: pagesMatch ? parseInt(pagesMatch[1], 10) : 1
      };
    }
  </script>
</body>
</html>
