<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Используем windows-1251, как на исходных страницах игры -->
  <meta charset="windows-1251">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Администрирование тех. клана (оптимизированное)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f2f2f2;
    }
    h1, h2, h3 {
      color: #333;
    }
    /* Блоки для ввода и отображения */
    .pair-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex: 1;
    }
    .card h3 {
      margin: 0 0 5px;
      font-size: 16px;
      text-align: center;
    }
    textarea {
      width: 100%;
      height: 80px;
      resize: none;
      font-family: monospace;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .display-box {
      width: 100%;
      height: 80px;
      border: 1px solid #ccc;
      background: #fafafa;
      overflow-y: auto;
      font-family: monospace;
      padding: 5px;
      border-radius: 3px;
    }
    .display-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 5px;
      border-bottom: 1px solid #eee;
    }
    .display-line:last-child {
      border-bottom: none;
    }
    .delete-btn {
      background: none;
      border: none;
      color: #d9534f;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    /* Кнопка и статус */
    #statusMessage {
      font-size: 16px;
      margin-bottom: 15px;
    }
    button {
      background: #337ab7;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #286090;
    }
    /* Collapsible списки (результаты) */
    .collapsible { margin-bottom: 10px; border: 1px solid #ccc; }
    .collapsible-header { background-color: #f0f0f0; padding: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    td a { text-decoration: none; color: blue; }
    td a:hover { text-decoration: underline; }
    .remove-button { color: red; border: none; background: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Администрирование тех. клана (оптимизированное)</h1>
  
  <!-- Пары полей ввода и отображения для технических кланов -->
  <div class="pair-container">
    <div class="card">
      <h3>Технические кланы (ID)</h3>
      <textarea id="techClans">9098</textarea>
    </div>
    <div class="card">
      <h3>Технические кланы (Название)</h3>
      <div id="techClansDisplay" class="display-box"></div>
    </div>
  </div>
  
  <!-- Пары для боевых кланов -->
  <div class="pair-container">
    <div class="card">
      <h3>Боевые кланы (ID)</h3>
      <textarea id="battleClans">1209
7490
7705
9595
5722</textarea>
    </div>
    <div class="card">
      <h3>Боевые кланы (Название)</h3>
      <div id="battleClansDisplay" class="display-box"></div>
    </div>
  </div>
  
  <!-- Пары для особенных игроков -->
  <div class="pair-container">
    <div class="card">
      <h3>Особенные игроки (ID)</h3>
      <textarea id="excludePlayers"></textarea>
    </div>
    <div class="card">
      <h3>Особенные игроки (Никнеймы)</h3>
      <div id="specialDisplay" class="display-box"></div>
    </div>
  </div>
  
  <!-- Статус и кнопка -->
  <div id="statusMessage"></div>
  <button id="processBtn">Обработать запрос</button>
  
  <!-- Результаты обработки -->
  <h2>Результаты:</h2>
  <div id="results"></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('clan2.html loaded');
      
      /* --- Синхронизация прокрутки для пар колонок --- */
      function syncScroll(inputId, displayId) {
        const textarea = document.getElementById(inputId);
        const display = document.getElementById(displayId);
        textarea.addEventListener('scroll', () => { display.scrollTop = textarea.scrollTop; });
        display.addEventListener('scroll', () => { textarea.scrollTop = display.scrollTop; });
      }
      syncScroll('techClans', 'techClansDisplay');
      syncScroll('battleClans', 'battleClansDisplay');
      
      /* --- Обновление правых колонок на основе серверных данных --- */
      let techResult = [];  // сервер возвращает массив объектов для тех. кланов
      function updateTechDisplay() {
        const displayDiv = document.getElementById('techClansDisplay');
        displayDiv.innerHTML = '';
        techResult.forEach(item => {
          const line = document.createElement('div');
          line.classList.add('display-line');
          line.textContent = `${item.clanId} - ${item.clanName}`;
          displayDiv.appendChild(line);
        });
      }
      
      let battleResult = []; // сервер возвращает массив объектов для боевых кланов
      function updateBattleDisplay() {
        const displayDiv = document.getElementById('battleClansDisplay');
        displayDiv.innerHTML = '';
        battleResult.forEach(item => {
          const line = document.createElement('div');
          line.classList.add('display-line');
          line.textContent = `${item.battleClanId} - ${item.battleClanName}`;
          displayDiv.appendChild(line);
        });
      }
      
      // Отображение особенных игроков (просто выводим ID, можно дополнить)
      function updateSpecialDisplay() {
        const textarea = document.getElementById('excludePlayers');
        const displayDiv = document.getElementById('specialDisplay');
        const lines = textarea.value.split('\n').map(s => s.trim()).filter(Boolean);
        displayDiv.innerHTML = '';
        lines.forEach(id => {
          const line = document.createElement('div');
          line.classList.add('display-line');
          line.textContent = id;
          displayDiv.appendChild(line);
        });
      }
      
      document.getElementById('battleClans').addEventListener('input', updateBattleDisplay);
      document.getElementById('excludePlayers').addEventListener('input', updateSpecialDisplay);
      
      // Восстанавливаем сохранённые значения из localStorage
      ['techClans', 'battleClans', 'excludePlayers'].forEach(id => {
        const saved = localStorage.getItem(id);
        if (saved !== null) {
          document.getElementById(id).value = saved;
        }
      });
      updateBattleDisplay();
      updateSpecialDisplay();
      
      /* --- Функции для отображения результатов (collapsible списки) --- */
      function updateGroupedHeader(groupedContainer) {
        const contentDiv = groupedContainer.children[1];
        let total = 0;
        if (contentDiv) {
          for (let i = 0; i < contentDiv.children.length; i++) {
            const inner = contentDiv.children[i];
            const innerHeader = inner.querySelector('.collapsible-header');
            if (innerHeader) {
              const match = innerHeader.textContent.match(/\((\d+)\)/);
              if (match) { total += parseInt(match[1], 10); }
            }
          }
        }
        const outerHeader = groupedContainer.firstElementChild;
        if (outerHeader) {
          const baseText = outerHeader.dataset.basetitle || outerHeader.textContent.split('(')[0].trim();
          outerHeader.dataset.basetitle = baseText;
          outerHeader.textContent = `${baseText} (${total})`;
        }
      }
      
      function createPlayerTable(items, groupType) {
        const table = document.createElement('table');
        items.forEach(item => {
          const tr = document.createElement('tr');
          const tdId = document.createElement('td');
          tdId.textContent = item.id;
          tr.appendChild(tdId);
          const tdName = document.createElement('td');
          const aName = document.createElement('a');
          aName.href = `https://www.heroeswm.ru/pl_info.php?id=${item.id}`;
          aName.target = '_blank';
          aName.textContent = item.name;
          tdName.appendChild(aName);
          tr.appendChild(tdName);
          const tdButton = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '✖';
          btn.classList.add('remove-button');
          btn.addEventListener('click', () => {
            const parentTable = tr.parentElement;
            tr.remove();
            const collapsible = parentTable.closest('.collapsible');
            if (collapsible) {
              const header = collapsible.querySelector('.collapsible-header');
              const newCount = parentTable.querySelectorAll('tr').length;
              header.textContent = header.textContent.replace(/\(\d+\)/, `(${newCount})`);
            }
            const outerGrouped = tr.closest('.grouped');
            if (outerGrouped) { updateGroupedHeader(outerGrouped); }
            const excludeTextarea = document.getElementById('excludePlayers');
            let currentExcludes = excludeTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (!currentExcludes.includes(item.id)) {
              currentExcludes.push(item.id);
              excludeTextarea.value = currentExcludes.join('\n');
              localStorage.setItem('excludePlayers', excludeTextarea.value);
              updateSpecialDisplay();
            }
          });
          tdButton.appendChild(btn);
          tr.appendChild(tdButton);
          table.appendChild(tr);
        });
        return table;
      }
      
      function createCollapsible(title, items, groupType) {
        const container = document.createElement('div');
        container.classList.add('collapsible');
        const header = document.createElement('div');
        header.classList.add('collapsible-header');
        header.textContent = title + ' (' + items.length + ')';
        container.appendChild(header);
        const content = document.createElement('div');
        content.style.display = 'none';
        const table = createPlayerTable(items, groupType);
        content.appendChild(table);
        container.appendChild(content);
        header.addEventListener('click', () => {
          content.style.display = content.style.display === 'none' ? 'block' : 'none';
        });
        return container;
      }
      
      function createGroupedCollapsible(groupedData, title, groupType) {
        const container = document.createElement('div');
        container.classList.add('collapsible', 'grouped');
        let totalCount = 0;
        Object.values(groupedData).forEach(group => {
          totalCount += group.players.length;
        });
        const header = document.createElement('div');
        header.classList.add('collapsible-header');
        header.dataset.basetitle = title;
        header.textContent = title + ' (' + totalCount + ')';
        container.appendChild(header);
        const content = document.createElement('div');
        content.style.display = 'none';
        Object.keys(groupedData).forEach(key => {
          const group = groupedData[key];
          const headerText = group.clanName.includes(`#${key}`) ? group.clanName : `${key} - ${group.clanName}`;
          const groupCollapsible = createCollapsible(headerText, group.players, groupType);
          content.appendChild(groupCollapsible);
        });
        container.appendChild(content);
        header.addEventListener('click', () => {
          content.style.display = content.style.display === 'none' ? 'block' : 'none';
        });
        return container;
      }
      
      function renderResults(data) {
        // Перед отображением, на клиенте отфильтруем особенных игроков
        const excludeList = document.getElementById('excludePlayers').value.split('\n').map(s => s.trim()).filter(Boolean);
        // Для каждого технического клана
        data.forEach(clan => {
          // Для enemyGroups: оставляем только тех, чьи id не содержатся в excludeList
          Object.keys(clan.enemyGroups).forEach(key => {
            clan.enemyGroups[key].players = clan.enemyGroups[key].players.filter(player => !excludeList.includes(player.id));
          });
        });
        
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        data.forEach(clan => {
          const clanContainer = document.createElement('div');
          clanContainer.style.marginBottom = '20px';
          const title = document.createElement('h3');
          if (clan.clanName.includes(`#${clan.clanId}`)) {
            title.textContent = clan.clanName;
          } else {
            title.textContent = `Клан ${clan.clanId} - ${clan.clanName}`;
          }
          clanContainer.appendChild(title);
          const columns = document.createElement('div');
          columns.style.display = 'flex';
          columns.style.gap = '10px';
          const inviteCollapsible = createGroupedCollapsible(clan.inviteGroups, 'Нужно пригласить', 'invite');
          const enemyCollapsible = createGroupedCollapsible(clan.enemyGroups, 'Ушёл во вражеские кланы', 'enemy');
          const clanlessCollapsible = createCollapsible('Без клана', clan.clanlessList, 'clanless');
          columns.appendChild(inviteCollapsible);
          columns.appendChild(enemyCollapsible);
          columns.appendChild(clanlessCollapsible);
          clanContainer.appendChild(columns);
          resultsDiv.appendChild(clanContainer);
        });
      }
      
      function saveField(id) {
        const value = document.getElementById(id).value;
        localStorage.setItem(id, value);
      }
      function loadField(id) {
        const value = localStorage.getItem(id);
        if (value !== null) {
          document.getElementById(id).value = value;
        }
      }
      ['techClans', 'battleClans', 'excludePlayers'].forEach(loadField);
      const savedResults = localStorage.getItem('results');
      if (savedResults) {
        document.getElementById('results').innerHTML = savedResults;
      }
      ['techClans', 'battleClans', 'excludePlayers'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => saveField(id));
      });
      
      /* ===== Обработка запроса к серверу (process2.js) ===== */
      function animateStatus(messageElement, baseText) {
        let dots = 0;
        return setInterval(() => {
          dots = (dots + 1) % 5;
          messageElement.textContent = baseText + '.'.repeat(dots);
        }, 1000);
      }
      const statusEl = document.getElementById('statusMessage');
      document.getElementById('processBtn').addEventListener('click', async () => {
        console.log('Обработка началась');
        const techClans = document.getElementById('techClans').value;
        const battleClans = document.getElementById('battleClans').value;
        const excludePlayers = document.getElementById('excludePlayers').value;
        console.log('Отправляем данные:', { techClans, battleClans, excludePlayers });
        statusEl.style.color = 'blue';
        let baseStatus = 'Ваш запрос отправлен. Ожидайте, пожалуйста';
        statusEl.textContent = baseStatus;
        const startTime = Date.now();
        const intervalId = animateStatus(statusEl, baseStatus);
        try {
          const res = await fetch('/.netlify/functions/process2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              techClanIds: techClans,
              battleClanIds: battleClans,
              excludePlayers: excludePlayers
            })
          });
          console.log('Ответ сервера:', res.status, res.statusText);
          clearInterval(intervalId);
          const elapsed = Math.round((Date.now() - startTime) / 1000);
          if (!res.ok) {
            statusEl.style.color = 'red';
            statusEl.textContent = `Возникла ошибка при обработке запроса. Запрос обрабатывался ${elapsed} секунд.`;
            throw new Error(`Ошибка запроса: ${res.status} ${res.statusText}`);
          }
          const data = await res.json();
          console.log('Полученные данные:', data);
          // Сервер возвращает массив объектов технических кланов
          updateTechDisplay();  // Обновляем правую колонку для тех. кланов
          updateBattleDisplay(); // Обновляем правую колонку для боевых кланов
          renderResults(data);
          localStorage.setItem('results', document.getElementById('results').innerHTML);
          statusEl.style.color = 'green';
          statusEl.textContent = `Ваш запрос обработан за ${elapsed} секунд.`;
        } catch (error) {
          console.error('Ошибка при обработке запроса:', error);
          clearInterval(intervalId);
          const elapsed = Math.round((Date.now() - startTime) / 1000);
          statusEl.style.color = 'red';
          statusEl.textContent = `Возникла ошибка при обработке запроса. Запрос обрабатывался ${elapsed} секунд.`;
          document.getElementById('results').innerText = 'Ошибка: ' + error.message;
        }
      });
    });
  </script>
</body>
</html>
