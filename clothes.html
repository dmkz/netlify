<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –≥–∞—Ä–¥–µ—Ä–æ–±–∞</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    .field { margin-bottom: 1rem; }
    .container { border: 1px solid #ccc; border-radius: 4px; margin-bottom: 1rem; padding: .5rem; }
    .header { font-weight: bold; }
    .entry { margin-left: 1rem; }
    .eye-btn { margin-left: .5rem; }
  </style>
</head>
<body>
  <h1>–ì–∞—Ä–¥–µ—Ä–æ–±: –ø–æ–¥–±–æ—Ä –æ–¥–µ–∂–¥—ã</h1>

  <div class="field">
    <label for="clothes">Clothes:</label>
    <input id="clothes" type="password" autocomplete="off">
    <button id="toggleMask" class="eye-btn">üëÅÔ∏è</button>
    <button id="load">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button>
  </div>

  <div id="results"></div>

  <script>
    const endpoint = 'https://dmkz.netlify.app/.netlify/functions/query';

    // –£–º–Ω–∞—è –º–∞—Å–∫–∞: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∏–ø –ø–æ–ª—è
    document.getElementById('toggleMask').addEventListener('click', () => {
      const inp = document.getElementById('clothes');
      inp.type = inp.type === 'password' ? 'text' : 'password';
    });

    // –ó–∞–ø—Ä–æ—Å –∏ —Ä–µ–Ω–¥–µ—Ä
    document.getElementById('load').addEventListener('click', async () => {
      const val = document.getElementById('clothes').value.trim();
      if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ clothes');

      // –ü–æ–º–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤–≤–µ–¥—ë–Ω–Ω–æ–µ
      localStorage.setItem('lastClothes', val);

      // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      const out = document.getElementById('results');
      out.innerHTML = '<p>–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</p>';

      try {
        const res = await fetch(`${endpoint}?clothes=${encodeURIComponent(val)}`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const rows = await res.json();

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ col1
        const groups = {};
        for (const r of rows) {
          const key = r.col1;
          groups[key] = groups[key] || [];
          groups[key].push(r);
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ desc
        const keys = Object.keys(groups).sort((a,b) => b.localeCompare(a, undefined, {numeric:true}));

        // –†–µ–Ω–¥–µ—Ä
        out.innerHTML = '';
        for (const key of keys) {
          const div = document.createElement('div');
          div.className = 'container';
          div.innerHTML = `<div class="header">${key}</div>`;
          // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ col2 (—á–∏—Å–ª–æ–≤–æ–π)
          groups[key]
            .sort((a,b) => a.col2 - b.col2)
            .forEach(r => {
              const e = document.createElement('div');
              e.className = 'entry';
              e.textContent = `${r.col2}. ${r.col3}: ${r.col4}`;
              div.appendChild(e);
            });
          out.appendChild(div);
        }
        if (!keys.length) out.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      } catch (err) {
        out.innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞: ${err.message}</p>`;
        console.error(err);
      }
    });

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    window.addEventListener('load', () => {
      const last = localStorage.getItem('lastClothes');
      if (last) document.getElementById('clothes').value = last;
    });
  </script>
</body>
</html>
