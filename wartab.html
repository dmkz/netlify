<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–Ω–∞–ª–∏–∑ –±–æ—ë–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π</title>
  <style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: auto;
      padding: 20px;
    }
    /* –ó–∞—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±—ã—Ç—å sticky, –∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ */
    .collapsible {
      cursor: pointer;              /* –≤—Å–µ–≥–¥–∞ pointer */
      transition: background 0.2s ease, color 0.2s ease;
      color: black;
      padding: 8px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 16px;
      border-radius: 4px;
      margin-bottom: 5px;
      position: sticky;
      top: 0px;
      border: 2px solid #8b4513;
      border-radius: 8px;
      background: #deb887;
      font-weight: bold;
    }
    .collapsible:hover {
        background: #d2a679;
    }
    #eventSelectorHeader {
        top: 0px;
        z-index: 1000;
    }
    #eventSelectorContainer {
        z-index: 1000;
    }
    #eventSelectorContainer, #battleToggle {
        top: 44px;
    }
    #battleToggle {
        z-index: 999;
    }
    #battleToggleContainer {
        z-index: 999;
    }
    #battleToggleContainer, #filterContainer {
        top: 88px;
    }
    #filterContainer {
        z-index: 998;
    }
    
    #eventSelectorContainer {
      /* —á—Ç–æ–±—ã –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –æ–Ω –æ—Å—Ç–∞–≤–∞–ª—Å—è –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º */
      margin-bottom: 20px;
    }
    .collapsible::after {
      content: "\25B6"; /* —Å—Ç—Ä–µ–ª–∫–∞ –≤–ø—Ä–∞–≤–æ */
      position: absolute;
      right: 8px;
      font-size: 16px;
    }
    .collapsible.active::after {
      content: "\25BC"; /* —Å—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ */
    }
    /* –ö–æ–Ω—Ç–µ–Ω—Ç –±–ª–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—ë–≤ ‚Äì –æ–±—ã—á–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ, –Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º —Å–≤–µ—Ä—Ö—É */
    .content {
      position: sticky;
      padding: 10px;
      display: none;
      overflow: hidden;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 20px;
      margin-top: 5px;
    }
    textarea {
      width: calc(100% - 20px);
      height: 150px;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow-y: scroll;
    }
    @media only screen and (max-width: 768px) and (orientation: portrait) {
      textarea {
        height: 350px;
        min-height: 350px;
      }
    }
    input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button.send {
      background-color: #28a745;
      color: #fff;
    }
    button.clear {
      background-color: #dc3545;
      color: #fff;
    }
    .filter-container {
      position: sticky;
      z-index: 990;
      background: rgba(240, 230, 210, 0.9);
      border: 2px solid #8b4513;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }
    .filter-header {
      background: #deb887;
      padding: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .filter-header:hover {
      background: #d2a679;
    }
    .filter-content {
      padding: 8px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .filter-content.collapsed {
      max-height: 0 !important;
      padding-top: 0;
      padding-bottom: 0;
      border: none;
    }
    .filter-group {
      margin-bottom: 8px;
    }
    .filter-group > .group-title {
      font-weight: bold;
      margin-bottom: 4px;
      text-align: center;
    }
    .filter-group .group-content{
      display:grid;
      /* –±–µ—Ä—ë–º —Å—Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫, —Å–∫–æ–ª—å–∫–æ –≤–ª–µ–∑–µ—Ç, 120¬†px ‚Äì –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —è—á–µ–π–∫–∏ */
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:8px;
    }
    .filter-group label {
      font-size: 14px;
    }
    .filter-group input[type="checkbox"] {
      margin-right: 4px;
    }
    .two-columns {
      display: flex;
      gap: 16px;
    }
    .two-columns .column {
      flex: 1;
    }
    .option {
      margin-bottom: 4px;
    }
    /* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
    .result-group {
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .collapsible-group {
      background-color: #e0e0e0;
      cursor: pointer;
      padding: 10px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      position: sticky;
      top: 0;
      z-index: 900;
    }
    .collapsible-group::after {
      content: "\25B6";
      position: absolute;
      right: 10px;
      font-size: 18px;
    }
    .collapsible-group.active::after {
      content: "\25BC";
    }
    .group-content {
      display: none;
      padding: 10px;
    }
    .group-title {
      font-weight: bold;
      margin-bottom: 5px;
      padding: 5px;
      background: #deb887;
      border-radius: 4px;
    }
    /* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ—ë–≤ */
    .battle {
      border-bottom: 1px dashed #ccc;
      padding: 10px 0;
      margin-bottom: 10px;
    }
    .battle:last-child {
      border-bottom: none;
    }
    .battle-link a {
      color: #007bff;
      text-decoration: none;
    }
    .battle-link a:hover {
      text-decoration: underline;
    }
    /* –°—Ç–∏–ª–∏ —Å—Ç—Ä–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ ‚Äì –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —É–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å */
    .result-line {
      padding: 5px;
      border-radius: 4px;
      margin-bottom: 3px;
      font-family: Consolas, "Courier New", monospace;
    }
    .result-line.win {
      background-color: #d4edda;
      color: #155724;
    }
    .result-line.lose {
      background-color: #f8d7da;
      color: #721c24;
    }
    .result-line.unknown {
      background-color: #fff3cd;
      color: #856404;
    }
    /* –°—Ç–∏–ª—å –¥–ª—è —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–∞ */
    .status-bar {
      background-color: #e9ecef;  /* —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
      border: 2px solid #ced4da;
      border-radius: 8px;
      padding: 10px;
      font-size: 18px;
      max-width: 960px;
      text-align: center;
      color: #495057;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      opacity: 0;
      /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
      animation: fadeIn 0.6s ease-in-out forwards;
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    /* –ö–ª–∞—Å—Å –¥–ª—è –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ */
    .status-update {
      animation: pulse 1.5s infinite;
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
      }
    }
    /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–∞ */
    .status-instruction-btn {
      background-color: #007bff;
      border: none;
      color: #fff;
      padding: 5px 10px;
      font-size: 14px;
      margin-right: 10px;
      float: left;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .status-instruction-btn:hover {
      background-color: #0056b3;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
    #instructionOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    #instructionModal {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .instruction-btn {
      padding: 8px 16px;
      margin: 10px 5px 0 5px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .instruction-btn.ok {
      background-color: #28a745;
      color: #fff;
    }

    .instruction-btn.ok:hover {
      background-color: #218838;
    }

    .instruction-btn.noShow {
      background-color: #6c757d;
      color: #fff;
    }

    .instruction-btn.noShow:hover {
      background-color: #5a6268;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ –æ—à–∏–±–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ */
    #errorModalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2100;
    }

    #errorModal {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –æ–∫–Ω–µ –æ—à–∏–±–∫–∏ */
    .error-btn {
      padding: 8px 16px;
      margin: 10px 5px 0 5px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .error-btn.copy {
      background-color: #17a2b8;
      color: #fff;
    }

    .error-btn.copy:hover {
      background-color: #117a8b;
    }

    .error-btn.close {
      background-color: #dc3545;
      color: #fff;
    }

    .error-btn.close:hover {
      background-color: #c82333;
    }
    
    .common-row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .inline-opt { display:flex; align-items:center; gap:4px; font-size:14px; }
    
    .copy-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      margin-left: 8px;
      color: #444;
      transition: color 0.2s;
    }
    .copy-btn:hover {
      color: #000;
    }
    .collapsible-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .collapsible-group .header-text {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- –°—Ç–∞—Ç—É—Å-–±–∞—Ä —Ä–∞–∑–º–µ—â—ë–Ω –≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
  <div class="status-bar" id="statusBar">
      <button class="status-instruction-btn" id="instructionToggleBtn">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
      <span id="statusText">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ–º –≤–≤–æ–¥–∞</span>
  </div>

  <div class="container">
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–±–æ—Ä–∞ –∏–≤–µ–Ω—Ç–∞ -->
    <button type="button" class="collapsible" id="eventSelectorHeader">
      –¢–µ–∫—É—â–∏–π –∏–≤–µ–Ω—Ç
    </button>
    <div class="content" id="eventSelectorContainer">
      <div style="margin:10px 0;">
        <label for="eventSelector">–ò–≤–µ–Ω—Ç:</label>
        <select id="eventSelector"></select>
      </div>
      <div>
        <strong>–ê–Ω–æ–Ω—Å:</strong>
        <a href="#" id="eventAnnouncement" target="_blank">‚Äî</a>
      </div>
      <div>
        <strong>–ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ:</strong>
        <a href="#" id="eventReward" target="_blank">‚Äî</a>
      </div>
      <div>
        <strong>–ú–∞—Ä–∫–µ—Ä—ã:</strong>
        <span id="eventMarkersDisplay">‚Äî</span>
      </div>
    </div>
    <!-- /–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–±–æ—Ä–∞ –∏–≤–µ–Ω—Ç–∞ -->
    <!-- –ë–ª–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—ë–≤ -->
    <button type="button" class="collapsible" id="battleToggle">–û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—ë–≤</button>
    <div class="content" id="battleToggleContainer">
      <textarea id="battleInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –±–æ–∏ –∏–≤–µ–Ω—Ç–∞...
–ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –∏–≤–µ–Ω—Ç—É —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –±–æ—ë–≤, –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å HTML –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –±–æ—ë–≤. –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ HTML —Å—Ç—Ä–∞–Ω–∏—Ü. 
–ü—Ä–æ—â–µ –≤—Å–µ–≥–æ: –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª –±–æ—ë–≤ –Ω–∞ –Ω—É–∂–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –Ω–∞–∂–º–∏—Ç–µ CTRL+U, –∑–∞—Ç–µ–º CTRL+A, CTRL+C –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ (CTRL+V).
–ë–æ–∏ –∏–≤–µ–Ω—Ç–∞ –±—É–¥—É—Ç –≤—ã–±—Ä–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã. –ë–æ—è–º–∏ –∏–≤–µ–Ω—Ç–∞ –±—É–¥—É—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è —Ç–µ –±–æ–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–ª–µ–¥—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã (–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):"></textarea>
      <input type="text" id="markersInput" placeholder="–ú–∞—Ä–∫–µ—Ä—ã –∏–≤–µ–Ω—Ç–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
      <div>
        <button class="send" id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="clear" id="clearButton">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
    <!-- –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="filter-container" id="filterContainer">
      <div class="filter-header" id="filterToggle">
        –§–∏–ª—å—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—è—Ö <span id="filterToggleIcon">&#9654;</span>
      </div>
      <div class="filter-content collapsed" id="filterContent">
        <div class="filter-group common-options">
          <div class="group-title">–û–±—â–∏–µ –æ–ø—Ü–∏–∏</div>
          <div class="group-content common-row">
              <!-- 1) –°–æ–∫—Ä–∞—â–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã -->
              <label class="inline-opt">
                <input type="checkbox" id="shortenMarkers" data-option="shortenMarkers">
                –°–æ–∫—Ä–∞—â–∞—Ç—å¬†–º–∞—Ä–∫–µ—Ä—ã
              </label>

              <!-- 2) –ù–∞—á–∞–ª–æ –±–æ—è -->
              <label class="inline-opt">
                <input type="checkbox" id="startFromBeg" data-option="startFromBeg">
                –ù–∞—á–∞–ª–æ¬†–±–æ—è
              </label>

              <!-- 3) –î–æ–º–µ–Ω -->
              <label class="inline-opt">
                <select id="domainSelect" data-option="domain">
                  <option>www.heroeswm.ru</option>
                  <option>mirror.heroeswm.ru</option>
                  <option>my.lordswm.com</option>
                  <option>www.lordswm.com</option>
                </select>
              </label>
            </div>
        </div>
        <div class="two-columns">
          <div class="column">
            <div class="group-title">–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</div>
            <!-- –ó–¥–µ—Å—å –≤–∞—à–∏ –æ–ø—Ü–∏–∏ –¥–ª—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π -->
            <div class="option">
              <input type="checkbox" id="showWinningSideName" data-option="showWinningSideName">
              <label for="showWinningSideName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω—ã</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningHP" data-option="showWinningHP">
              <label for="showWinningHP">–°—É–º–º–∞—Ä–Ω–æ–µ –•–ü</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningPercent" data-option="showWinningPercent">
              <label for="showWinningPercent">% –≤—ã–∂–∏–≤—à–∏—Ö</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningFaction" data-option="showWinningFaction">
              <label for="showWinningFaction">–§—Ä–∞–∫—Ü–∏—è</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningHeroInfo" data-option="showWinningHeroInfo">
              <label for="showWinningHeroInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ—è—Ö</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningHeroNickname" data-option="showWinningHeroNickname">
              <label for="showWinningHeroNickname">–ù–∏–∫–Ω–µ–π–º –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningHeroLevel" data-option="showWinningHeroLevel">
              <label for="showWinningHeroLevel">–£—Ä–æ–≤–µ–Ω—å –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningHeroParams" data-option="showWinningHeroParams">
              <label for="showWinningHeroParams">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="shortenWinningHeroParams" data-option="shortenWinningHeroParams">
              <label for="shortenWinningHeroParams">–°–æ–∫—Ä–∞—â–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningArmy" data-option="showWinningArmy">
              <label for="showWinningArmy">–ê—Ä–º–∏—è</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showWinningBonuses" data-option="showWinningBonuses">
              <label for="showWinningBonuses">–ë–æ–Ω—É—Å—ã</label>
            </div>
          </div>
          <div class="column">
            <div class="group-title">–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏–µ</div>
            <!-- –ó–¥–µ—Å—å –≤–∞—à–∏ –æ–ø—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö -->
            <div class="option">
              <input type="checkbox" id="showLosingSideName" data-option="showLosingSideName">
              <label for="showLosingSideName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω—ã</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingHP" data-option="showLosingHP">
              <label for="showLosingHP">–°—É–º–º–∞—Ä–Ω–æ–µ –•–ü</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingPercent" data-option="showLosingPercent">
              <label for="showLosingPercent">% –≤—ã–∂–∏–≤—à–∏—Ö</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingFaction" data-option="showLosingFaction">
              <label for="showLosingFaction">–§—Ä–∞–∫—Ü–∏—è</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingHeroInfo" data-option="showLosingHeroInfo">
              <label for="showLosingHeroInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ—è—Ö</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingHeroNickname" data-option="showLosingHeroNickname">
              <label for="showLosingHeroNickname">–ù–∏–∫–Ω–µ–π–º –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingHeroLevel" data-option="showLosingHeroLevel">
              <label for="showLosingHeroLevel">–£—Ä–æ–≤–µ–Ω—å –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingHeroParams" data-option="showLosingHeroParams">
              <label for="showLosingHeroParams">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="shortenLosingHeroParams" data-option="shortenLosingHeroParams">
              <label for="shortenLosingHeroParams">–°–æ–∫—Ä–∞—â–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ—Ä–æ–µ–≤</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingArmy" data-option="showLosingArmy">
              <label for="showLosingArmy">–ê—Ä–º–∏—è</label>
            </div>
            <div class="option">
              <input type="checkbox" id="showLosingBonuses" data-option="showLosingBonuses">
              <label for="showLosingBonuses">–ë–æ–Ω—É—Å—ã</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="resultsContainer"></div>
  </div>

  <script>
  
  // ============ –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ============
  async function loadAllBattlesParallel() {
    try {
      console.log('üîÑ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...');
      const startTime = Date.now();
      
      const firstResponse = await fetch('/.netlify/functions/getBattles?page=0&pageSize=1000');
      if (!firstResponse.ok) {
        throw new Error(`HTTP error! status: ${firstResponse.status}`);
      }
      
      const firstData = await firstResponse.json();
      console.log(`üìä –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: ${firstData.recordsInPage} –∏–∑ ${firstData.totalRecords} –∑–∞–ø–∏—Å–µ–π`);
      console.log(`üìÑ –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: ${firstData.totalPages}`);
      
      const allEvents = firstData.events;
      let allExamples = [...firstData.examples];
      
      if (firstData.totalPages <= 1) {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${elapsed}—Å`);
        return { events: allEvents, examples: allExamples };
      }
      
      // Parallel loading with error handling
      const pagePromises = [];
      for (let page = 1; page < firstData.totalPages; page++) {
        pagePromises.push(
          fetch(`/.netlify/functions/getBattles?page=${page}&pageSize=1000`)
            .then(res => {
              if (!res.ok) throw new Error(`HTTP error on page ${page}! status: ${res.status}`);
              return res.json();
            })
            .then(data => {
              console.log(`‚úì –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1}/${firstData.totalPages}: ${data.recordsInPage} –∑–∞–ø–∏—Å–µ–π`);
              return data.examples;
            })
            .catch(err => {
              console.error(`‚ùå –û—à–∏–±–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${page}:`, err);
              return []; // Return empty array instead of failing entire load
            })
        );
      }
      
      console.log(`‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º ${pagePromises.length} —Å—Ç—Ä–∞–Ω–∏—Ü –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...`);
      const results = await Promise.all(pagePromises);
      
      results.forEach(pageExamples => {
        allExamples.push(...pageExamples);
      });
      
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${elapsed}—Å! –í—Å–µ–≥–æ –ø—Ä–∏–º–µ—Ä–æ–≤: ${allExamples.length}`);
      
      return { events: allEvents, examples: allExamples };
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
      throw error;
    }
  }
// ============ –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ============

    document.addEventListener('DOMContentLoaded', async () => {
      // –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã
      const statusBar = document.getElementById('statusBar');
      const battleToggle = document.getElementById('battleToggle');
      document.querySelectorAll('.collapsible').forEach(button => {
          // –∑–¥–µ—Å—å button ‚Äî —ç—Ç–æ –∏ ¬´–í—ã–±—Ä–∞–Ω –∏–≤–µ–Ω—Ç¬ª, –∏ ¬´–û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—ë–≤¬ª
          const content = button.nextElementSibling;
          button.addEventListener('click', () => {
            button.classList.toggle('active');
            if (content.style.display === 'block') {
              content.style.display = 'none';
            } else {
              content.style.display = 'block';
            }
          });
        });

      const battleInput = document.getElementById('battleInput');
      const markersInput = document.getElementById('markersInput');
      const sendButton = document.getElementById('sendButton');
      const clearButton = document.getElementById('clearButton');
      const resultsContainer = document.getElementById('resultsContainer');
      const eventSelectorHeader    = document.getElementById('eventSelectorHeader');
      const eventSelectorContainer = document.getElementById('eventSelectorContainer');
      const eventSelector          = document.getElementById('eventSelector');
      const eventAnnouncement      = document.getElementById('eventAnnouncement');
      const eventReward            = document.getElementById('eventReward');
      const eventMarkersDisplay    = document.getElementById('eventMarkersDisplay');

      /* –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ "–∞–∫—Ç–∏–≤–Ω–æ–≥–æ" —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–∞ */
      function startStatusUpdate() {
        console.log("startStatusUpdate –≤—ã–∑–≤–∞–Ω–∞ –≤ " + new Date().toLocaleTimeString());
        statusBar.classList.add('status-update');
      }

      /* –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
      function stopStatusUpdate() {
        console.log("stopStatusUpdate –≤—ã–∑–≤–∞–Ω–∞ –≤ " + new Date().toLocaleTimeString());
        statusBar.classList.remove('status-update');
      }

      clearButton.addEventListener('click', function() {
        battleInput.value = '';
        document.getElementById('statusText').textContent = '–°—Ç–∞—Ç—É—Å: –æ—á–∏—â–µ–Ω–æ';
      });

      /* –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" */
      sendButton.addEventListener('click', async function() {
        document.getElementById('statusText').textContent = '–°—Ç–∞—Ç—É—Å: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞...';
        // 1) –°–≤–µ—Ä–Ω—É—Ç—å –±–ª–æ–∫ "–û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—ë–≤", –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
        if (battleToggle.classList.contains('active')) {
          battleToggle.classList.remove('active');
          battleToggle.nextElementSibling.style.display = 'none';
        }

        // 2) –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä—É (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª —Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
        statusBar.scrollIntoView({ behavior: 'smooth' });
        const inputText = battleInput.value;
        if (!inputText.trim()) {
          document.getElementById('statusText').textContent = '–°—Ç–∞—Ç—É—Å: –ø—É—Å—Ç–æ–π –≤–≤–æ–¥';
          return;
        }

        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–æ–∏ –∏–∑ –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        let battleLinks = extractBattleLinks(inputText);
        if (battleLinks.length === 0) {
          document.getElementById('statusText').textContent = '–°—Ç–∞—Ç—É—Å: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –±–æ–∏';
          return;
        }

        // –ü—Ä–∏–≤–æ–¥–∏–º —Å—Å—ã–ª–∫–∏ –∫ –Ω—É–∂–Ω–æ–π —Ñ–æ—Ä–º–µ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º warid
        let newBattles = battleLinks.map(link => {
          const normalized = normalizeBattleLink(link);
          const warid = extractWarId(normalized);
          return { warid, link: normalized, result: null };
        }).filter(b => b.warid);

        // –ü–æ–ª—É—á–∞–µ–º —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –±–æ–∏
        let dbBattles = allExamples.slice();

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º: –µ—Å–ª–∏ –±–æ–π —Å —Ç–∞–∫–∏–º warid —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äì –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ (—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞)
        let battlesMap = {};
        console.log(`–ë–æ–µ–≤ –≤ dbBattles –¥–æ: ${dbBattles.length}`);
        console.log(`–ë–æ–µ–≤ –≤ newBattles –¥–æ: ${dbBattles.length}`);
        dbBattles.forEach(b => { battlesMap[b.warid] = b; });
        newBattles.forEach(b => {
          if (!battlesMap[b.warid]) battlesMap[b.warid] = b;
        });
        
        let allBattles = Object.values(battlesMap);

        document.getElementById('statusText').textContent = `–°—Ç–∞—Ç—É—Å: ${allBattles.length} –±–æ—ë–≤, –æ–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞...`;

        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ –±–æ–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        allBattles = await analyzeBattles(allBattles);
        // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω—ã –º–∞—Ä–∫–µ—Ä—ã –∏–≤–µ–Ω—Ç–∞ ‚Äì —Ñ–∏–ª—å—Ç—Ä—É–µ–º
        const markers = markersInput.value.split(',')
                              .map(m => m.trim())
                              .filter(m => m);
        if (markers.length > 0) {
          const filtered = allBattles.filter(b => battleHasMarkers(b.result, markers));
          allBattles = filtered;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –±–æ–∏ –Ω–æ–≤—ã–µ (—Ç.–µ. –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –±–∞–∑–µ)
        let newInDB = allBattles.filter(b => !dbBattles.some(db => db.warid === b.warid));

        // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –±–æ–∏ ‚Äì –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –ø–∞—á–∫–æ–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        if (newInDB.length > 0) {
          try {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏: battles –∏ markers
            const selectedEventId = Number(eventSelector.value);
            console.log(`selectedEventId: ${selectedEventId}`);
            const payload = {
              battles: newInDB, 
              markers: markersInput.value,
              eventId: selectedEventId 
            };
            const updateRes = await fetch('/.netlify/functions/updateBattles', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!updateRes.ok) {
              console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã");
            }
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–∑—ã:", error);
          }
        }

        // Reload data after submitting battles
        try {
            statusText.textContent = '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';
            const data = await loadAllBattlesParallel();
            allEvents   = data.events   || [];
            allExamples = data.examples || [];
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –±–∞–∑–µ:", error);
          statusText.textContent = '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        }
        //allExamples = allBattles;
        handleEventChange();
        
        //displayBattles(allBattles);
        //updateFilteredOutput();
        document.getElementById('statusText').textContent = `–°—Ç–∞—Ç—É—Å: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ–≥–æ –±–æ—ë–≤: ${allBattles.length}`;
      });

      /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –±–æ—è */
      function extractBattleLinks(text) {
        const regex = /(?:https?:\/\/[^\s'"]+)?\/?(war(?:log)?\.php\?[^"'\s]+)/gi;
        let links = [];
        let match;
        while ((match = regex.exec(text)) !== null) {
          links.push(match[1]);
        }
        return links;
      }

      function normalizeBattleLink(link) {
        if (!link.startsWith('http')) {
          link = 'https://www.heroeswm.ru/' + link;
        } else {
          link = link.replace(/https?:\/\/(www\.heroeswm\.ru|mirror\.heroeswm\.ru|my\.lordswm\.com|www\.lordswm\.com|lordswm\.com)/i, 'https://www.heroeswm.ru');
        }
        link = link.replace(/warlog\.php/gi, 'war.php');
        try {
          let url = new URL(link);
          url.searchParams.delete('lt');
          return url.toString();
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏:', link, e);
          return link;
        }
      }

      function extractWarId(link) {
        try {
          let url = new URL(link);
          return url.searchParams.get('warid');
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è warid –∏–∑ —Å—Å—ã–ª–∫–∏:', link, e);
          return null;
        }
      }

      /* –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –±–æ—ë–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é) */
      async function analyzeBattles(battles) {
          const toAnalyze = battles.filter(b => !b.result);
          const total     = toAnalyze.length;
          const BATCH_SIZE   = 200;
          const MAX_ATTEMPTS = 5;

          let permanentlyFailed = [];
          let processed = 0;
          const t0 = performance.now();

          for (let i = 0; i < total; i += BATCH_SIZE) {
            const chunk = toAnalyze.slice(i, i + BATCH_SIZE);
            let attempt = 1,
                success = false;

            while (attempt <= MAX_ATTEMPTS && !success) {
              // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
              const elapsed = ((performance.now() - t0) / 1000).toFixed(3);
              statusText.textContent = 
                `–°—Ç–∞—Ç—É—Å: ${processed}/${total} –±–æ—ë–≤. ` +
                `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${chunk.length} —Å—Å—ã–ª–æ–∫, –ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${MAX_ATTEMPTS}. ` +
                `–í—Ä–µ–º—è: ${elapsed} —Å–µ–∫`;

              try {
                const res = await fetch(
                  '/.netlify/functions/analyzeBattles',
                  {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ links: chunk.map(b=>b.link) })
                  }
                );
                if (!res.ok) {
                  attempt++;
                  await new Promise(r=>setTimeout(r,1000));
                  continue;
                }
                const data = await res.json();
                if (!Array.isArray(data.results)) {
                  attempt++;
                  await new Promise(r=>setTimeout(r,1000));
                  continue;
                }

                // –ü–æ–º–µ—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ –≥–æ—Ç–æ–≤—ã–µ
                data.results.forEach(r => {
                  const b = battles.find(x => x.link === r.link);
                  if (b && r.status === 'success' && r.result) {
                    b.result = r.result;
                    processed++;
                  }
                });
                success = true;
              } catch (err) {
                attempt++;
                await new Promise(r=>setTimeout(r,1000));
              }
            }

            if (!success) {
              permanentlyFailed.push(...chunk);
            }
          }

          // –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
          const totalElapsed = ((performance.now() - t0) / 1000).toFixed(3);
          statusText.textContent = 
            `–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω: ${processed}/${total} –±–æ—ë–≤ –∑–∞ ${totalElapsed} —Å–µ–∫`;

          if (permanentlyFailed.length) {
            showAnalysisErrorModal(permanentlyFailed);
            battles = battles.filter(b => b.result !== null);
          }

          return battles;
        }


    function showAnalysisErrorModal(failedBattles) {
  let modalOverlay = document.createElement('div');
  modalOverlay.id = 'errorModalOverlay';

  let modal = document.createElement('div');
  modal.id = 'errorModal';

  modal.innerHTML = `
    <h2>–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</h2>
    <p>
      –°–ª–µ–¥—É—é—â–∏–µ –±–æ–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –±–æ–ª–µ–µ 5):
    </p>
    <!-- –í–º–µ—Å—Ç–æ —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º textarea -->
    <textarea id="failedBattlesTextarea" readonly style="width:100%; height:150px; font-family: Consolas, 'Courier New', monospace; padding:10px; border:1px solid #ccc; border-radius:4px; resize:vertical;">
${failedBattles.map(b => b.link).join('\n')}
    </textarea>
    <p>–û–¥–Ω–∞–∫–æ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ–∏ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã!</p>
    <div style="text-align: right;">
      <button class="error-btn copy" id="copyFailedBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="error-btn close" id="closeErrorModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;

  modalOverlay.appendChild(modal);
  document.body.appendChild(modalOverlay);

  document.getElementById('copyFailedBtn').addEventListener('click', () => {
    let tempTextarea = document.createElement('textarea');
    tempTextarea.value = failedBattles.map(b => b.link).join('\n');
    document.body.appendChild(tempTextarea);
    tempTextarea.select();
    document.execCommand('copy');
    document.body.removeChild(tempTextarea);
    alert('–°—Å—ã–ª–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!');
  });

  document.getElementById('closeErrorModalBtn').addEventListener('click', () => {
    document.body.removeChild(modalOverlay);
  });
}



      function battleHasMarkers(result, markers) {
        if (!result) return false;
        return markers.some(marker => {
          const regex = new RegExp('\\[' + marker + '(\\s*[({]|\\])', 'i');
          return regex.test(result);
        });
      }
      
      const defaultFilterOptions = {
          shortenMarkers: true,
          startFromBeg: false,
          domain: "www.heroeswm.ru",
          showWinningSideName: true,
          showLosingSideName: true,
          showWinningHP: false,
          showLosingHP: true,
          showWinningPercent: true,
          showLosingPercent: false,
          showWinningFaction: true,
          showLosingFaction: true,
          showWinningHeroInfo: false,
          showLosingHeroInfo: true,
          showWinningHeroNickname: false,
          showLosingHeroNickname: true,
          showWinningHeroLevel: false,
          showLosingHeroLevel: true,
          showWinningHeroParams: false,
          showLosingHeroParams: true,
          shortenWinningHeroParams: false,
          shortenLosingHeroParams: true,
          showWinningArmy: false,
          showLosingArmy: true,
          showWinningBonuses: true,
          showLosingBonuses: false
    };
    function loadFilterOptions() {
      let stored = localStorage.getItem("battleFilterOptions");
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          return Object.assign({}, defaultFilterOptions);
        }
      }
      return Object.assign({}, defaultFilterOptions);
    }
    function saveFilterOptions(options) {
      localStorage.setItem("battleFilterOptions", JSON.stringify(options));
    }
    let filterOptions = loadFilterOptions();
    document.querySelectorAll("#filterContent input[type=checkbox]").forEach(cb => {
      let option = cb.getAttribute("data-option");
      cb.checked = !!filterOptions[option];
      cb.addEventListener("change", function() {
        filterOptions[option] = this.checked;
        saveFilterOptions(filterOptions);
        updateFilteredOutput();
      });
    });
    // —Å–µ–ª–µ–∫—Ç –¥–æ–º–µ–Ω–∞
    const domainSel = document.getElementById("domainSelect");
    domainSel.value = filterOptions.domain;
    domainSel.addEventListener("change", () => {
      filterOptions.domain = domainSel.value;
      saveFilterOptions(filterOptions);
      updateFilteredOutput();
    });

    // —á–µ–∫–±–æ–∫—Å ¬´–ù–∞—á–∞–ª–æ –±–æ—è¬ª
    const begChk = document.getElementById("startFromBeg");
    begChk.checked = !!filterOptions.startFromBeg;
    begChk.addEventListener("change", () => {
      filterOptions.startFromBeg = begChk.checked;
      saveFilterOptions(filterOptions);
      updateFilteredOutput();
    });
      /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
      function extractWinningLevel(resultText, markers) {
          if (!resultText) return "–ë–µ–∑ —É—Ä–æ–≤–Ω—è";
          let lines = resultText.split('\n').map(l => l.trim());
          let maxLevel = 0;
          outer: for (let line of lines) {
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ –º–∞—Ä–∫–µ—Ä–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë
            for (let marker of markers) {
              if (line.toLowerCase().includes(marker.toLowerCase())) {
                continue outer;
              }
            }
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä–∫–µ—Ä–æ–≤, –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å —É—Ä–æ–≤–µ–Ω—å
            let match = line.match(/\[–£—Ä–æ–≤–µ–Ω—å:\s*(\d+)\]/i);
            if (match) {
              maxLevel = Math.max(maxLevel, parseInt(match[1], 10));
            }
          }
          if (maxLevel !== 0) {
            return "[–£—Ä–æ–≤–µ–Ω—å: " + maxLevel + "]";
          }
          return "–ë–µ–∑ —É—Ä–æ–≤–Ω—è";
        }


      function extractFaction(result) {
        if (!result) return "–ë–µ–∑ —Ñ—Ä–∞–∫—Ü–∏–∏";
        let lines = result.split('\n').map(l => l.trim());
        for (let line of lines) {
          if (line.toLowerCase().startsWith('[win') || line.startsWith('[+]')) {
            let blocks = [];
            const regex = /\[([^\]]+)\]/g;
            let match;
            while ((match = regex.exec(line)) !== null) {
              blocks.push(match[1].trim());
            }
            if (blocks.length >= 5) return blocks[4];
          }
        }
        return "–ë–µ–∑ —Ñ—Ä–∞–∫—Ü–∏–∏";
      }

      function extractSurvivalPercent(result, markers) {
          if (!result) return 0;
          let lines = result.split('\n').map(l => l.trim());
          let maxSurv = 0.0;
          outer: for (let line of lines) {
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ –º–∞—Ä–∫–µ—Ä–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë
            for (let marker of markers) {
              if (line.toLowerCase().includes(marker.toLowerCase())) {
                continue outer;
              }
            }
            let blocks = [];
            const regex = /\[([^\]]+)\]/g;
            let match;
            while ((match = regex.exec(line)) !== null) {
              blocks.push(match[1].trim());
            }
            if (blocks.length >= 4) {
              let percentMatch = blocks[3].match(/(\d+(\.\d+)?)%/);
              if (percentMatch) {
                maxSurv = Math.max(maxSurv, parseFloat(percentMatch[1]));
              }
            }
          }
          return maxSurv;
        }


      function updateFilteredOutput() {
          /* --- –ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–æ–∫ -------------------------------------------------- */
          const needBeg   = !!filterOptions.startFromBeg;
          const newDomain = filterOptions.domain || "www.heroeswm.ru";

          document.querySelectorAll(".battle-link a").forEach(a => {
            try {
              const url = new URL(a.href);

              /* –¥–æ–º–µ–Ω */
              url.hostname = newDomain;

              /* lt –ø–∞—Ä–∞–º–µ—Ç—Ä */
              if (needBeg) {
                url.searchParams.set("lt", "-1");     // –ø—Ä–æ—Å—Ç–æ ‚Äú&lt‚Äù ‚Äî LWM / HWM –ø–æ–Ω–∏–º–∞—é—Ç
              } else {
                url.searchParams.delete("lt");
              }

              a.href = url.toString();
              a.textContent = a.href;
            } catch (_) {}
          });
        document.querySelectorAll('.battle-result').forEach(resultDiv => {
          let original = resultDiv.parentNode.dataset.originalResult;
          if (!original) return;
          resultDiv.innerHTML = "";
          let lines = original.split('\n');
          lines.forEach(line => {
            let newLine = transformLine(line, filterOptions);
            let lineDiv = document.createElement('div');
            lineDiv.className = 'result-line';
            lineDiv.textContent = newLine;
            if (newLine.startsWith('[win!]') || newLine.startsWith('[+]')) {
              lineDiv.classList.add('win');
            } else if (newLine.startsWith('[lose]') || newLine.startsWith('[-]')) {
              lineDiv.classList.add('lose');
            } else if (newLine.startsWith('[?]')) {
              lineDiv.classList.add('unknown');
            }
            resultDiv.appendChild(lineDiv);
          });
        });
      }

      function shortenHeroParams(paramsBlock) {
        const mapping = {
          "–ù–∞–ø–∞–¥–µ–Ω–∏–µ:": "–ù:",
          "–ó–∞—â–∏—Ç–∞:": "–ó:",
          "–°–∏–ª–∞ –º–∞–≥–∏–∏:": "–°–ú:",
          "–ó–Ω–∞–Ω–∏—è:": "–ó–ù:",
          "–£–¥–∞—á–∞:": "–£–¥:",
          "–ë–æ–µ–≤–æ–π –î—É—Ö:": "–ë–î:",
          "–£—Ä–æ–≤–µ–Ω—å:": "–£:"
        };
        for (let key in mapping) {
          let shortKey = mapping[key];
          let regex = new RegExp(key, "gi");
          paramsBlock = paramsBlock.replace(regex, shortKey);
        }
        return paramsBlock.replace(/\s+/g, "");
      }

      function transformHeroBlock(heroBlock, isWinner, opts) {
        if ((isWinner && !opts.showWinningHeroInfo) || (!isWinner && !opts.showLosingHeroInfo))
          return "";
        let firstBracket = heroBlock.indexOf("[");
        let nickname = "";
        let blocks = [];
        if (firstBracket !== -1) {
          nickname = heroBlock.substring(0, firstBracket).trim();
          let regex = /\[([^\]]+)\]/g;
          let m;
          while ((m = regex.exec(heroBlock)) !== null) {
            blocks.push(m[1]);
          }
        } else {
          nickname = heroBlock.trim();
        }
        let levelBlock = "";
        let paramsBlock = "";
        if (blocks.length > 0) {
          if (/–£—Ä–æ–≤–µ–Ω—å:|^–£—Ä:/i.test(blocks[0])) {
            levelBlock = blocks[0];
            if (blocks.length > 1) {
              paramsBlock = blocks.slice(1).join("][");
            }
          } else {
            paramsBlock = blocks.join("][");
          }
        }
        if ((isWinner && !opts.showWinningHeroNickname) || (!isWinner && !opts.showLosingHeroNickname))
          nickname = "";
        if (!((isWinner && opts.showWinningHeroLevel) || (!isWinner && opts.showLosingHeroLevel))) {
          levelBlock = "";
        } else if (levelBlock) {
          if ((isWinner && opts.shortenWinningHeroParams) || (!isWinner && opts.shortenLosingHeroParams)) {
            levelBlock = levelBlock.replace(/–£—Ä–æ–≤–µ–Ω—å:/gi, "–£—Ä:").replace(/\s+/g, "");
          }
          levelBlock = "[" + levelBlock + "]";
        }
        if (!((isWinner && opts.showWinningHeroParams) || (!isWinner && opts.showLosingHeroParams))) {
          paramsBlock = "";
        } else if (paramsBlock) {
          let tmp = "[" + paramsBlock + "]";
          if ((isWinner && opts.shortenWinningHeroParams) || (!isWinner && opts.shortenLosingHeroParams)) {
            tmp = shortenHeroParams(tmp);
          }
          paramsBlock = tmp;
        }
        let result = (nickname + levelBlock + paramsBlock).trim();
        return result;
      }

      function replacePrefix(str, prefix, replacement) {
        if (str.toLowerCase().startsWith(prefix.toLowerCase())) {
          return replacement + str.slice(prefix.length);
        }
        return str;
      }

      function transformLine(line, opts) {
        let trimmed = line.trim();
        if (!trimmed.startsWith("[")) return line;
        let inner = trimmed.substring(1, trimmed.length - 1);
        let blocks = inner.split("] [");
        let marker = blocks[0];
        let isWinner = (marker.toLowerCase().includes("win") || marker.indexOf("+") !== -1);
        if (isWinner) {
          if (opts.shortenMarkers) {
            if (marker.toLowerCase().startsWith("win!")) {
              blocks[0] = replacePrefix(marker, "win!", "+");
            }
          }
        } else {
          if (opts.shortenMarkers && marker.toLowerCase().startsWith("lose")) {
            blocks[0] = replacePrefix(marker, "lose", "-");
          }
        }
        if ((isWinner && !opts.showWinningSideName) || (!isWinner && !opts.showLosingSideName)) {
          blocks[1] = "";
        }
        if ((isWinner && !opts.showWinningHP) || (!isWinner && !opts.showLosingHP)) {
          blocks[2] = "";
        }
        if ((isWinner && !opts.showWinningPercent) || (!isWinner && !opts.showLosingPercent)) {
          blocks[3] = "";
        }
        if ((isWinner && !opts.showWinningFaction) || (!isWinner && !opts.showLosingFaction)) {
          blocks[4] = "";
        }
        let heroBlockExists = false;
        let heroIdx = 5;
        if (blocks.length > heroIdx && blocks[heroIdx].includes("–£—Ä–æ–≤–µ–Ω—å:")) {
          heroBlockExists = true;
          blocks[heroIdx] = transformHeroBlock(blocks[heroIdx], isWinner, opts);
        }
        let armyIdx = heroBlockExists ? 6 : 5;
        if (blocks.length > armyIdx) {
          if ((isWinner && !opts.showWinningArmy) || (!isWinner && !opts.showLosingArmy)) {
            blocks[armyIdx] = "";
          }
        }
        let bonusIdx = heroBlockExists ? 7 : 6;
        if (blocks.length > bonusIdx) {
          if ((isWinner && !opts.showWinningBonuses) || (!isWinner && !opts.showLosingBonuses)) {
            blocks[bonusIdx] = "";
          }
        }
        let newLine = blocks.filter(b => b !== "").map(b => "[" + b + "]").join(" ");
        return newLine;
      }

      function transformTokensText(inputText, opts) {
        let lines = inputText.split("\n");
        let transformed = lines.map(line => transformLine(line, opts));
        return transformed.join("\n");
      }

      /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è */
      function getLevelGradient(level) {
        // –£—Ä–æ–≤–µ–Ω—å –æ—Ç 5 –¥–æ 25 (–≤—Å–µ–≥–æ 21 —É—Ä–æ–≤–µ–Ω—å)
        // –ü—Ä–∏ —É—Ä–æ–≤–Ω–µ 5: —Ö–æ–ª–æ–¥–Ω—ã–π (–≥–æ–ª—É–±–æ–π ~hsl(240, 70%, 50%))
        // –ü—Ä–∏ —É—Ä–æ–≤–Ω–µ 25: –∂–∞—Ä–∫–∏–π (–∫—Ä–∞—Å–Ω—ã–π ~hsl(0, 70%, 50%))
        let clamped = Math.min(Math.max(level, 5), 25);
        let fraction = (clamped - 5) / 20;
        let hue = 240 - fraction * 240;  // –ª–∏–Ω–µ–π–Ω–æ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç 240 –¥–æ 0
        // –°–æ–∑–¥–∞–¥–∏–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –±–æ–ª–µ–µ —Ç—ë–º–Ω–æ–≥–æ –∫ –±–æ–ª–µ–µ —Å–≤–µ—Ç–ª–æ–º—É –æ—Ç—Ç–µ–Ω–∫—É —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
        return `linear-gradient(90deg, hsl(${hue}, 70%, 40%), hsl(${hue}, 70%, 60%))`;
      }
        
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        function parseGroupHeader(header) {
          // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç: "–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å)" ‚Äì —Å–∫–æ–±–∫–∏ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å ‚Äì –ª—é–±–æ–π —Å–∏–º–≤–æ–ª –¥–æ –ø–µ—Ä–≤–æ–π –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å ‚Äì –≤—Å—ë, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Å–∫–æ–±–æ–∫
          const regex = /^(.*?)\s*(?:\((.+?)\))?$/;
          const match = header.match(regex);
          if (match) {
            return {
              main: match[1].trim(),
              extra: (match[2] || "").trim()
            };
          }
          return { main: header, extra: "" };
        }

        function compareGroupHeaders(a, b) {
          // –†–∞–∑–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç–∏.
          let parsedA = parseGroupHeader(a);
          let parsedB = parseGroupHeader(b);

          // –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
          let mainCompare = parsedA.main.localeCompare(parsedB.main, undefined, { sensitivity: "base" });
          if (mainCompare !== 0) {
            return mainCompare;
          }
          
          // –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —á–∞—Å—Ç–∏ —Ä–∞–≤–Ω—ã, —Ç–æ –ø—ã—Ç–∞–µ–º—Å—è —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã.
          let regex = /^(\d+)/; // –≤—ã–¥–µ—Ä–≥–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
          let matchA = parsedA.extra.match(regex);
          let matchB = parsedB.extra.match(regex);
          
          if (matchA && matchB) {
            let numA = parseInt(matchA[1], 10);
            let numB = parseInt(matchB[1], 10);
            if (numA !== numB) {
              return numA - numB; // –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–∏–π –ø–æ—Ä—è–¥–æ–∫: –º–µ–Ω—å—à–∏–µ —á–∏—Å–ª–∞ –∏–¥—É—Ç —Ä–∞–Ω—å—à–µ
            }
            // –ï—Å–ª–∏ —á–∏—Å–ª–æ–≤—ã–µ —á–∞—Å—Ç–∏ —Ä–∞–≤–Ω—ã, –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –∏ –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            return parsedA.extra.localeCompare(parsedB.extra, undefined, { sensitivity: "base" });
          }
          
          // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏—Ö –æ–±—ã—á–Ω—ã–º –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏
          return parsedA.extra.localeCompare(parsedB.extra, undefined, { sensitivity: "base" });
        }


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥—Ä—É–ø–ø—ã —É—Ä–æ–≤–Ω—è
        function extractLevelNumber(levelHeader) {
          // –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫: "[–£—Ä–æ–≤–µ–Ω—å: 18]"
          const regex = /\[–£—Ä–æ–≤–µ–Ω—å:\s*(\d+)\]/i;
          const match = levelHeader.match(regex);
          return match ? parseInt(match[1], 10) : 0;
        }
        
      /* –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –±–æ—ë–≤ */
      function displayBattles(battles) {
        const markers = markersInput.value.split(',')
                            .map(m => m.trim())
                            .filter(m => m);
        resultsContainer.innerHTML = '';
        let overallGroups = {};
        battles.forEach(battle => {
          let key = determineGroupKey(battle.result, markers);
          if (!overallGroups[key]) overallGroups[key] = [];
          overallGroups[key].push(battle);
        });
        // –ü—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ –æ–±—â–∏—Ö –≥—Ä—É–ø–ø –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ:
        let overallKeys = Object.keys(overallGroups);
        overallKeys.sort(compareGroupHeaders);
        overallKeys.forEach((overallKey) => {
          let overallDiv = document.createElement('div');
          overallDiv.className = 'result-group';
          let overallHeader = document.createElement('div');
          overallHeader.className = 'collapsible-group';
          
          // –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ (—á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –º–µ—à–∞–ª–∞ wrap)
            let overallText = document.createElement('span');
            overallText.className = 'header-text';
            overallText.textContent = overallKey;
            overallHeader.appendChild(overallText);

            // –∫–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            let overallCopy = document.createElement('button');
            overallCopy.className = 'copy-btn';
            overallCopy.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É';
            overallCopy.textContent = 'üìã';
            overallHeader.appendChild(overallCopy);

            overallDiv.appendChild(overallHeader);
            // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
            function isVisible(el) {
              return el.offsetParent !== null &&
                     getComputedStyle(el).visibility !== 'hidden';
            }

            overallCopy.addEventListener('click', function(event) {
              event.stopPropagation();
              event.preventDefault();

              const overallContent = overallHeader.nextElementSibling;
              if (!isVisible(overallContent)) {
                alert('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –≤—ã –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –±–æ—ë–≤');
                return;
              }

              const lines = [];
              // --- helper –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å–µ–∫—Ü–∏–π —Å –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π ---
              function addSection(text) {
                if (lines.length && lines[lines.length - 1] !== '') {
                  lines.push('');
                }
                lines.push(text);
              }
              // –ø—Ä–æ—Å—Ç–æ–π –¥–æ–±–∞–≤–∏—Ç–µ–ª—å —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥ –Ω–µ–π
              function addLine(text) {
                lines.push(text);
              }

              // 1) –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã
              addLine(overallText.textContent.trim());

              // 2) –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Ä–æ–≤–Ω–µ–π
              const levelDivs = Array.from(overallContent.children)
                .filter(div => div.querySelector('.collapsible-group'));

              levelDivs.forEach(levelDiv => {
                const levelHeader = levelDiv.querySelector('.collapsible-group');
                const lvlContent  = levelHeader.nextElementSibling;

                // 3) –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ —É—Ä–æ–≤–Ω–∏
                if (!isVisible(lvlContent)) return;

                // 4) –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
                const lvlTextEl = levelHeader.querySelector('.header-text');
                const lvlText = lvlTextEl
                  ? lvlTextEl.textContent.trim()
                  : levelHeader.textContent.replace('üìã','').trim();
                addSection(lvlText);

                // 5) –∏—Ç–µ—Ä–∏—Ä—É–µ–º —Å—Ä–∞–∑—É –ø–æ –≤—Å–µ–º —É–∑–ª–∞–º –≤–Ω—É—Ç—Ä–∏ lvlContent
                let lastFaction = null;
                Array.from(lvlContent.children).forEach(node => {
                  // 5.1) –≤—Å—Ç—Ä–µ—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫-—Ñ—Ä–∞–∫—Ü–∏—é ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º lastFaction
                  if (node.classList.contains('group-title')) {
                    lastFaction = null;
                    // –≤–º–µ—Å—Ç–æ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ span.header-text
                    const hdr = node.querySelector('.header-text');
                    node._factionText = hdr
                      ? hdr.textContent.trim()
                      : '';
                  }
                  // 5.2) –≤—Å—Ç—Ä–µ—á–∞–µ–º –±–æ–π
                  if (node.classList.contains('battle') && isVisible(node)) {
                    // 6) –Ω–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç —Ñ—Ä–∞–∫—Ü–∏–∏
                    const siblings = Array.from(lvlContent.children);
                    const idx = siblings.indexOf(node);
                    const frNode = siblings
                      .slice(0, idx)
                      .reverse()
                      .find(n => n.classList.contains('group-title'));
                    // –æ–ø—è—Ç—å: –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ span.header-text
                    let factionText = null;
                    if (frNode) {
                    const hdr = frNode.querySelector('.header-text');
                    factionText = hdr
                        ? hdr.textContent.trim()
                        : frNode._factionText;  // fallback, —Ö–æ—Ç—è –≤—ã—à–µ –º—ã –ø—Ä–æ–ø–∏—Å–∞–ª–∏ _factionText —Ç–æ–∂–µ –∏–∑ span
                    }

                    // 7) –µ—Å–ª–∏ –Ω–æ–≤–∞—è —Ñ—Ä–∞–∫—Ü–∏—è ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º –µ—ë –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    if (factionText && factionText !== lastFaction) {
                      addSection(factionText);
                      lastFaction = factionText;
                    }

                    // 8) –∏ —Å–∞–º –±–æ–π
                    addLine(node.innerText.trim());
                  }
                });
              });

              // 9) –∫–æ–ø–∏—Ä—É–µ–º, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–∞–±—Ä–∞–ª–æ—Å—å
              if (lines.length > 1) {
                navigator.clipboard.writeText(lines.join('\n'))
                  .then(() => alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —Ä–∞—Å–∫—Ä—ã—Ç–æ'))
                  .catch(err => console.error(err));
              } else {
                alert('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –≤—ã –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –±–æ—ë–≤');
              }
            });


          
          let overallContent = document.createElement('div');
          overallContent.className = 'group-content';

          // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é –ø–æ–±–µ–¥–∏–≤—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã
          let levelGroups = {};
          overallGroups[overallKey].forEach(battle => {
            // TO DO:
            let lvl = extractWinningLevel(battle.result, markers);
            if (!levelGroups[lvl]) levelGroups[lvl] = [];
            levelGroups[lvl].push(battle);
          });
          let levelKeys = Object.keys(levelGroups);
          levelKeys.sort((a, b) => {
            let numA = extractLevelNumber(a);
            let numB = extractLevelNumber(b);
            return numB - numA;
          });

          levelKeys.forEach(levelKey => {
            let battlesAtLevel = levelGroups[levelKey];
            let bestSurvival = Math.max(...battlesAtLevel.map(battle => extractSurvivalPercent(battle.result, markers)));
            let levelDiv = document.createElement('div');
            let levelHeader = document.createElement('div');
            levelHeader.className = 'collapsible-group';
            
            // 2) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∫–æ–Ω–∫—É –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
            const levelText = document.createElement('span');
            levelText.className = 'header-text';
            levelText.textContent = `${levelKey} [–≤—ã–∂–∏–ª–æ ${bestSurvival.toFixed(2)}% —É –ª—É—á—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞]`;
            levelHeader.appendChild(levelText);

            // 3) –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—à–µ–≥–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
            let levelNum = extractLevelNumber(levelKey);
            levelHeader.style.background = getLevelGradient(levelNum);
            levelHeader.style.color      = '#fff';

            // 4) –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è
            const levelCopy = document.createElement('button');
            levelCopy.type        = 'button';
            levelCopy.className   = 'copy-btn';
            levelCopy.title       = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å';
            levelCopy.textContent = 'üìã';
            levelHeader.appendChild(levelCopy);

             levelCopy.addEventListener('click', function(event) {
               event.stopPropagation();
               event.preventDefault();

               const isVisible = el => el && getComputedStyle(el).display !== 'none';

               const lines = [];
               const addSection = txt => {
                 if (lines.length && lines[lines.length-1] !== '') lines.push('');
                 lines.push(txt);
               };
               const addLine = txt => lines.push(txt);

               // 3.1) –µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å —Å–≤–µ—Ä–Ω—É—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
               const lvlContent = levelHeader.nextElementSibling;
               if (!isVisible(lvlContent)) {
                    alert('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –≤—ã –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –±–æ—ë–≤');
                    return;
               }

               // 3.2) –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è
               addLine(levelText.textContent.trim());

               // 3.3) –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ñ—Ä–∞–∫—Ü–∏–∏ –∏ –±–æ–∏ –≤–Ω—É—Ç—Ä–∏ lvlContent
               let lastFaction = null;
               Array.from(lvlContent.children).forEach(node => {
                 if (node.classList.contains('group-title')) {
                   lastFaction = null;
                   // –≤–º–µ—Å—Ç–æ node.textContent: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç span.header-text
                   const hdr = node.querySelector('.header-text');
                   node._factionText = hdr
                   ? hdr.textContent.trim()
                   : ''; 

                 }
                 if (node.classList.contains('battle') && isVisible(node)) {
                   const siblings = Array.from(lvlContent.children);
                   const idx = siblings.indexOf(node);
                   const frNode = siblings.slice(0, idx).reverse()
                                     .find(n => n.classList.contains('group-title'));
                   // —Å–Ω–æ–≤–∞ —á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ span.header-text, –∞ –Ω–µ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                   let factionText = null;
                   if (frNode) {
                   const hdr = frNode.querySelector('.header-text');
                   factionText = hdr
                       ? hdr.textContent.trim()
                       : frNode._factionText;
                   }

                   if (factionText && factionText !== lastFaction) {
                     addSection(factionText);
                     lastFaction = factionText;
                   }
                   addLine(node.innerText.trim());
                 }
               });

               // 3.4) –∫–æ–ø–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–∞—à–ª–æ—Å—å —á—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
               if (lines.length > 1) {
                 navigator.clipboard.writeText(lines.join('\n'))
                   .then(() => alert('–£—Ä–æ–≤–µ–Ω—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤–º–µ—Å—Ç–µ —Å –≤–∏–¥–∏–º—ã–º–∏ –±–æ—è–º–∏'))
                   .catch(err => console.error(err));
               } else {
                alert('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –≤—ã –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –±–æ—ë–≤');
               }
             });
            
            
            levelDiv.appendChild(levelHeader);
            
            let levelContent = document.createElement('div');
            levelContent.className = 'group-content';

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ—Ä–∞–∫—Ü–∏–∏
            let factionGroups = {};
            battlesAtLevel.forEach(battle => {
              let faction = extractFaction(battle.result);
              if (!factionGroups[faction]) factionGroups[faction] = [];
              factionGroups[faction].push(battle);
            });
            let factionKeys = Object.keys(factionGroups);
            factionKeys.sort((a, b) => {
              let bestA = Math.max(...factionGroups[a].map(battle => extractSurvivalPercent(battle.result, markers)));
              let bestB = Math.max(...factionGroups[b].map(battle => extractSurvivalPercent(battle.result, markers)));
              return bestB - bestA;
            });
            factionKeys.forEach(factionKey => {
              let best = Math.max(...factionGroups[factionKey].map(battle => extractSurvivalPercent(battle.result, markers)));
              let factionHeader = document.createElement('div');
              factionHeader.className = 'group-title';
                // 1) –£–±–∏—Ä–∞–µ–º –ø—Ä—è–º—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É textContent
                //    –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ <span>
                const factionTextSpan = document.createElement('span');
                factionTextSpan.className = 'header-text';
                factionTextSpan.textContent = `${factionKey} [–≤—ã–∂–∏–ª–æ ${best.toFixed(2)}% —É –ª—É—á—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞]`;
                factionHeader.textContent = '';
                factionHeader.appendChild(factionTextSpan);

                // 2) –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—Ä–∞–∫—Ü–∏–∏
                const factionCopy = document.createElement('button');
                factionCopy.type        = 'button';
                factionCopy.className   = 'copy-btn';
                factionCopy.title       = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ—Ä–∞–∫—Ü–∏—é';
                factionCopy.textContent = 'üìã';
                factionHeader.appendChild(factionCopy);

                // 3) –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                factionCopy.addEventListener('click', function(event) {
                  event.stopPropagation();
                  event.preventDefault();

                  // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                  const isVisible = el => el && getComputedStyle(el).display === 'block';

                  const lines = [];
                  // –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –ø–µ—Ä–µ–¥ –Ω–∏–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                  const addSection = txt => {
                    if (lines.length && lines[lines.length - 1] !== '') lines.push('');
                    lines.push(txt);
                  };
                  // –ø—Ä–æ—Å—Ç–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏
                  const addLine = txt => lines.push(txt);
                  // 3.2) –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ—Ä–∞–∫—Ü–∏–∏ (—Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                  addSection(factionTextSpan.textContent.trim());

                  // –Ω–∞—á–∏–Ω–∞–µ–º —Å–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ sibling
                    let sib = factionHeader.nextElementSibling;
                    while (sib && !sib.classList.contains('group-title')) {
                      // —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –±–æ–∏, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –≤–∏–¥–∏–º—ã
                      if (
                        sib.classList.contains('battle') &&
                        sib.offsetParent !== null  // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´–≤–∏–¥–∏–º–æ—Å—Ç–∏¬ª
                      ) {
                        addLine(sib.innerText.trim());
                      }
                      sib = sib.nextElementSibling;
                    }

                  // 3.4) –∫–æ–ø–∏—Ä—É–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–æ–π
                  if (lines.length > 1) {
                    navigator.clipboard.writeText(lines.join('\n'))
                      .then(() => alert('–§—Ä–∞–∫—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤–º–µ—Å—Ç–µ —Å –≤–∏–¥–∏–º—ã–º–∏ –±–æ—è–º–∏'))
                      .catch(err => console.error(err));
                  } else {
                    alert('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –≤—ã –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –±–æ—ë–≤');
                  }
                });

                // 4) –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ—Ä–∞–∫—Ü–∏–∏ –≤ DOM
                levelContent.appendChild(factionHeader);
                
              factionGroups[factionKey].sort((a, b) => {
                return extractSurvivalPercent(b.result, markers) - extractSurvivalPercent(a.result, markers);
              });
              factionGroups[factionKey].forEach(battle => {
                let battleDiv = document.createElement('div');
                battleDiv.className = 'battle';
                battleDiv.dataset.originalResult = battle.result;
                let linkDiv = document.createElement('div');
                linkDiv.className = 'battle-link';
                let linkA = document.createElement('a');
                let battleLink = `https://www.heroeswm.ru/war.php?warid=${battle.warid}`;

                if (battle.enemy) {
                  // –æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Äî showt –∏ show_enemy
                  battleLink += `&showt=${battle.show}&show_enemy=${battle.enemy}`;
                } else if (battle.show) {
                  battleLink += `&show=${battle.show}`;
                }

                //console.log("battleLink:", battleLink);
                linkA.href = battleLink;
                linkA.target = '_blank';
                linkA.textContent = battleLink;
                linkDiv.appendChild(linkA);
                battleDiv.appendChild(linkDiv);
                let resultDiv = document.createElement('div');
                resultDiv.className = 'battle-result';
                if (battle.result) {
                  battle.result.split('\n').forEach(line => {
                    let lineDiv = document.createElement('div');
                    lineDiv.className = 'result-line';
                    lineDiv.textContent = line;
                    if (line.startsWith('[win!]') || line.startsWith('[+]')) {
                      lineDiv.classList.add('win');
                    } else if (line.startsWith('[lose]') || line.startsWith('[-]')) {
                      lineDiv.classList.add('lose');
                    } else if (line.startsWith('[?]')) {
                      lineDiv.classList.add('unknown');
                    }
                    resultDiv.appendChild(lineDiv);
                  });
                }
                battleDiv.appendChild(resultDiv);
                levelContent.appendChild(battleDiv);
              });
            });
            levelDiv.appendChild(levelContent);
            overallContent.appendChild(levelDiv);

            levelHeader.addEventListener('click', function() {
              this.classList.toggle('active');
              let content = this.nextElementSibling;
              content.style.display = (content.style.display === 'block') ? 'none' : 'block';
            });
          });

          overallDiv.appendChild(overallContent);
          resultsContainer.appendChild(overallDiv);

          overallHeader.addEventListener('click', function() {
            this.classList.toggle('active');
            let content = this.nextElementSibling;
            content.style.display = (content.style.display === 'block') ? 'none' : 'block';
          });
        });
        updateFilteredOutput();
      }
      
      function handleEventChange() {
          currentEventId = Number(eventSelector.value);
          const ev = allEvents.find(e => e.eventId === currentEventId);

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          eventSelectorHeader.textContent = `${ev.title}`;
          eventAnnouncement.href    = ev.announcement || '#';
          eventAnnouncement.textContent = ev.announcement ? '–ü–µ—Ä–µ–π—Ç–∏' : '‚Äî';
          eventReward.href          = ev.reward       || '#';
          eventReward.textContent   = ev.reward ? '–ü–µ—Ä–µ–π—Ç–∏' : '‚Äî';
          eventMarkersDisplay.textContent = ev.eventMarkers;
          markersInput.value = ev.eventMarkers;

          // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä—ã
          const examplesFor = allExamples.filter(x => x.eventId === currentEventId);
          statusText.textContent = `–°–æ–±—ã—Ç–∏–µ ${currentEventId}: ${examplesFor.length} –±–æ—ë–≤`;
          displayBattles(examplesFor);
          updateFilteredOutput();
        }

      
      function determineGroupKey(result, eventMarkers) {
        if (!result) return '–ë–µ–∑ –≥—Ä—É–ø–ø—ã';
        const lines = result.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        for (const line of lines) {
          let blocks = [];
          const regex = /\[([^\]]+)\]/g;
          let match;
          while ((match = regex.exec(line)) !== null) {
            blocks.push(match[1].trim());
          }
          if (!blocks.length) continue;
          for (let i = 0; i < blocks.length; i++) {
            for (const marker of eventMarkers) {
              if (blocks[i].toLowerCase().startsWith(marker.toLowerCase())) {
                const remainder = blocks[i].substring(marker.length).trim();
                if (remainder && (remainder.startsWith('(') || remainder.startsWith('{'))) {
                  return blocks[i];
                } else {
                  if (i + 3 < blocks.length) {
                    return marker + ": " + blocks[i + 3];
                  } else {
                    return marker;
                  }
                }
              }
            }
          }
        }
        return '–ë–µ–∑ –≥—Ä—É–ø–ø—ã';
      }

      /* –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ */
      const filterToggle = document.getElementById("filterToggle");
      const filterContent = document.getElementById("filterContent");
      const filterToggleIcon = document.getElementById("filterToggleIcon");
      
      filterToggle.addEventListener("click", () => {
        if (filterContent.classList.contains("collapsed")) {
          filterContent.classList.remove("collapsed");
          filterToggleIcon.innerHTML = "&#9660;";
        } else {
          filterContent.classList.add("collapsed");
          filterToggleIcon.innerHTML = "&#9654;";
        }
      });

      /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–≤–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
        try {
          statusText.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–≤–µ–Ω—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã...';
          const t0 = performance.now();

          const data = await loadAllBattlesParallel();
          allEvents   = data.events   || [];
          allExamples = data.examples || [];

          // –û—á–∏—Å—Ç–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          eventSelector.innerHTML = '';

          // –ù–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
          allEvents
            .sort((a,b) => a.eventId - b.eventId)
            .forEach(ev => {
              const opt = document.createElement('option');
              opt.value = ev.eventId;
              opt.text  = `${ev.eventId}: ${ev.title}`;
              eventSelector.appendChild(opt);
            });

          // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π eventId –∏ —Å—Ä–∞–∑—É —Ä–µ–Ω–¥–µ—Ä–∏–º
          currentEventId      = Math.max(...allEvents.map(e=>e.eventId));
          eventSelector.value = currentEventId;

          // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–ø–∫—É –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—ã–±–æ—Ä–∞ –∏–≤–µ–Ω—Ç–∞
          const chosen = allEvents.find(e => e.eventId === currentEventId);
          eventSelectorHeader.textContent  = `${chosen.title}`;
          eventAnnouncement.href           = chosen.announcement || '#';
          eventAnnouncement.textContent    = chosen.announcement ? '–ü–µ—Ä–µ–π—Ç–∏' : '‚Äî';
          eventReward.href                 = chosen.reward || '#';
          eventReward.textContent          = chosen.reward ? '–ü–µ—Ä–µ–π—Ç–∏' : '‚Äî';
          eventMarkersDisplay.textContent  = chosen.eventMarkers;
          markersInput.value               = chosen.eventMarkers;

          // –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
          eventSelector.addEventListener('change', handleEventChange);

          // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –ø—Ä–∏–º–µ—Ä–æ–≤
          handleEventChange();

          const t1 = ((performance.now() - t0)/1000).toFixed(2);
          statusText.textContent = `–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞ ${t1}s ‚Äî –∏–≤–µ–Ω—Ç–æ–≤: ${allEvents.length}, –ø—Ä–∏–º–µ—Ä–æ–≤: ${allExamples.length}`;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:', e);
          statusText.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        }
    });
    function showInstructionModal() {
      let overlay = document.createElement('div');
      overlay.id = 'instructionOverlay';

      let modal = document.createElement('div');
      modal.id = 'instructionModal';
      // –ó–¥–µ—Å—å –≤—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –û–Ω –±–æ–ª—å—à–æ–π, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—É—é —Å—Ç—Ä–æ–∫—É.
      modal.innerHTML = `
        <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∞–π—Ç–∞</h2>
        <p>
          <strong>–ü—Ä–æ—Å–º–æ—Ç—Ä –±–æ—ë–≤</strong><br>
          –ö–æ–≥–¥–∞ –≤—ã –∑–∞—Ö–æ–¥–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –æ–Ω –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Ç—Ç—É–¥–∞ —É–∂–µ –∏–º–µ—é—â–∏–µ—Å—è –±–æ–∏. –£ –º–µ–Ω—è —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç 3 —Å–µ–∫—É–Ω–¥—ã. –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –±–æ–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞–º –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ –≤–æ–ª–Ω. –î–ª—è –∫–∞–∂–¥–æ–π –≤–æ–ª–Ω—ã –±–æ–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –±–æ–µ–≤—ã–º —É—Ä–æ–≤–Ω—è–º –≥–µ—Ä–æ–µ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö —É–±—ã–≤–∞–Ω–∏—è. –°–ø–∏—Å–æ–∫ —É—Ä–æ–≤–Ω–µ–π –∏–º–µ–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞: –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –≥–µ—Ä–æ–∏ –±–ª–∏–∂–µ –∫ –∫—Ä–∞—Å–Ω–æ–º—É, –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –±–ª–∏–∂–µ –∫ —Å–∏–Ω–µ–º—É.<br><br>

          <strong>–§–∏–ª—å—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—è—Ö</strong><br>
          –û–± –æ–¥–Ω–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –±–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –∫—Ç–æ —Å—Ä–∞–∂–∞–ª—Å—è, —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –•–ü —É –µ–≥–æ –∞—Ä–º–∏–∏, —Å–∫–æ–ª—å–∫–æ % –≤—ã–∂–∏–ª–æ, –∫—Ç–æ –±—ã–ª –≤ –µ–≥–æ –∞—Ä–º–∏–∏, –∫–∞–∫–∞—è —Ñ—Ä–∞–∫—Ü–∏—è, —á—Ç–æ –æ–Ω –ø–æ–ª—É—á–∏–ª –∑–∞ –±–æ–π, –∫–∞–∫–∏–µ —Å—Ç–∞—Ç—ã –±—ã–ª–∏ —É –≥–µ—Ä–æ—è, –∏ —Ç.–¥.. –í –±—É–¥—É—â–µ–º –ø–ª–∞–Ω–∏—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å, –∫–∞–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–æ—Å–∏–ª –≥–µ—Ä–æ–π, –∫–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —É –Ω–µ–≥–æ –±—ã–ª–∏ –∏ –∫–∞–∫–æ–µ —É–º–µ–Ω–∏–µ —Ñ—Ä–∞–∫—Ü–∏–∏ –∏ –∞–Ω—Ç–∏-—É–º–µ–Ω–∏–µ —Ñ—Ä–∞–∫—Ü–∏–∏, –Ω–æ —Å–µ–π—á–∞—Å —ç—Ç–æ–≥–æ –Ω–µ—Ç.<br><br>

          –ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑–±—ã—Ç–æ—á–Ω–æ–π, —Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã: –æ—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏ —Ç–æ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –≤—Å–µ –æ–ø–∏—Å–∞–Ω–∏—è –±–æ—ë–≤ —Å—Ä–∞–∑—É –∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è ¬´–Ω–∞–ª–µ—Ç—É¬ª, –ø–æ—ç—Ç–æ–º—É —Ç–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞, –∫–∞–∫ ¬´–ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã¬ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.<br><br>

          <strong>–û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—ë–≤</strong><br>
          –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ: —Ç–µ–∫—Å—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–æ–∏, –∏–ª–∏ HTML –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –±–æ—ë–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –±–æ–∏. –í—Å—ë, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç ¬´war.php¬ª –∏–ª–∏ ¬´warlog.php¬ª –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –±–æ–µ–º. –î–∞–∂–µ –µ—Å–ª–∏ www.heroeswm.ru –∏–ª–∏ lordswm.com –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–≤—ã –º–æ–≥–ª–∏ —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å —ç—Ç–∏–º, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –ø–æ—á—Ç—É –≥–µ—Ä–æ–µ–≤ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ), —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–æ–∏ –±—É–¥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑—ä—è—Ç—ã, –∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ www.heroeswm.ru –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.<br><br>

          –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ –±–æ–π —è–≤–ª—è–µ—Ç—Å—è –±–æ–µ–º –∏–≤–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, —á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å, —É–∫–∞–∑–∞–Ω–∞ –≤ –ø–æ–ª–µ –ø–æ–¥ –≤–≤–æ–¥–æ–º —Ç–µ–∫—Å—Ç–∞. –°–µ–π—á–∞—Å —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ ¬´–¶–µ–ª—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞¬ª. –ê–Ω–∞–ª–∏–∑ –±–æ—ë–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–æ–π –≤–µ–¥—ë—Ç –Ω–∞ lordswm.com, —Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ –Ω–∞ www.heroeswm.ru, –ø–æ—ç—Ç–æ–º—É, –µ—Å–ª–∏ –≤—ã –∞–Ω–≥–ª–æ–≥–æ–≤–æ—Ä—è—â–∏–π, —Ç–æ –≤–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–∏ –±–æ–∏ –∏ –≤—Å—ë (–∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ –∫–∞–∫ HTML –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –±–æ—ë–≤).<br><br>

          –°–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—Å—Ç–∞–≤–∫–∏ HTML –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ: –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –±–æ—ë–≤ Ctrl+U, Ctrl+A, Ctrl+C, –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞, Ctrl+V.<br><br>

          –î—É–±–ª–∏–∫–∞—Ç—ã –±–æ—ë–≤ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–µ —Å—Å—ã–ª–∫–∞, –∞ –ø–∞—Ä–∞–º–µ—Ç—Ä ¬´warid¬ª: –¥–≤–µ —Å—Å—ã–ª–∫–∏ —Å –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ ¬´warid¬ª —Å—á–∏—Ç–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏.<br><br>

          –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: —è –ø—Ä–æ–≤–µ—Ä—è–ª –Ω–∞ Mozilla Firefox Mobile. –ù–æ —è —É—Å—Ç–∞–Ω–æ–≤–∏–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ ¬´View Page Source¬ª –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π Firefox.<br><br>

          –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—ë–≤ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É —Å—Ä–∞–∑—É: –¥–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ.<br><br>

          <strong>–î—Ä—É–≥–∏–µ –∏–≤–µ–Ω—Ç—ã</strong><br>
          –ü–æ–∫–∞ —á—Ç–æ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤–æ–≥–æ –∏–≤–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Ä—É—á–Ω—É—é. –Ø –¥–æ–ª–∂–µ–Ω —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å –º–∞—Ä–∫–µ—Ä—ã –±–æ—ë–≤ –∏–≤–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–¶–µ–ª—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞¬ª) –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∏–≤–µ–Ω—Ç–∞. –ù–æ –Ω–∞ –∏–≤–µ–Ω—Ç–∞—Ö, –≥–¥–µ –Ω–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –≤–æ–ª–Ω, —É–∂–µ —Å–µ–π—á–∞—Å –≤—Ä–∞–≥–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –Ω–µ –ø–æ –Ω–æ–º–µ—Ä–∞–º –≤–æ–ª–Ω, –∞ –ø–æ —Ñ—Ä–∞–∫—Ü–∏—è–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä, ¬´–í—Ä–∞–≥–∏: –ú–µ—Ö–∞–Ω–∏–∫–∏¬ª, –∏–ª–∏ ¬´–í—Ä–∞–≥–∏: –†–∞–∑–±–æ–π–Ω–∏–∫–∏¬ª –≤–º–µ—Å—Ç–æ ¬´–¶–µ–ª—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (10-1)¬ª –∏ ¬´–¶–µ–ª—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (40-2)¬ª.
        </p>
        <div style="text-align: center; margin-top: 20px;">
          <button class="instruction-btn ok" id="instructionOk">–ü–æ–Ω—è–ª</button>
          <button class="instruction-btn noShow" id="instructionNoShow">–ë–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</button>
        </div>
      `;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      document.getElementById('instructionOk').addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      document.getElementById('instructionNoShow').addEventListener('click', () => {
        localStorage.setItem('dontShowInstructions', 'true');
        document.body.removeChild(overlay);
      });
    }

    function checkAndShowInstructions() {
      if (!localStorage.getItem('dontShowInstructions')) {
        showInstructionModal();
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–µ
    document.addEventListener('DOMContentLoaded', () => {
      checkAndShowInstructions();
      const instructionToggleBtn = document.getElementById('instructionToggleBtn');
      instructionToggleBtn.addEventListener('click', showInstructionModal);
    });
  </script>
</body>
</html>
