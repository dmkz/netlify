<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Анализ ссылок на бои с фильтрацией (2025)</title>
  <style>
    /* Базовый сброс */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      height: 100vh;
      overflow: hidden;
    }

    /* Контейнер, делящий страницу на две половины */
    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }
    
    /* Левая панель */
    .left-panel {
      width: 50%;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-right: 2px solid #ddd;
    }
    
    /* Правая панель */
    .right-panel {
      width: 50%;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #fafafa;
    }
    
    /* Текстовые поля занимают оставшееся пространство и скроллятся */
    textarea {
      width: 100%;
      resize: none;
      padding: 8px;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    /* Текстовое поле ввода занимает всю оставшуюся высоту левой панели */
    #inputText {
      flex: 1;
      margin-bottom: 8px;
    }
    
    /* Вывод результата также растягивается */
    #outputArea {
      flex: 1;
    }
    
    /* Кнопка Анализировать */
    #analyzeButton {
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background-color 0.2s ease-in-out;
    }
    
    #analyzeButton:hover {
      background-color: #0056b3;
    }
    
    /* Статус анализа */
    #statusDisplay {
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    /* Фильтр — контейнер для опций */
    .filter-container {
      background: rgba(240, 230, 210, 0.9); /* прозрачность */
      border: 2px solid #8b4513;
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }
    
    /* Заголовок фильтра — область для сворачивания/разворачивания */
    .filter-header {
      background: #deb887;
      padding: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .filter-header:hover {
      background: #d2a679;
    }
    
    /* Контент фильтра с опциями в две колонки */
    .filter-content {
      padding: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .filter-content div {
      background: rgba(255, 255, 255, 0.8);
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    /* Состояние свёрнутого фильтра */
    .collapsed {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      border: none;
    }
    
    /* Дополнительный современный вид: небольшая тень */
    .left-panel, .right-panel, .filter-container {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Левая панель: фильтр, ввод и кнопка -->
    <div class="left-panel">
      <!-- Фильтр, располагающийся над полем ввода -->
      <div class="filter-container" id="filterContainer">
        <div class="filter-header" id="filterToggle">
          Фильтры <span id="toggleIcon">&#9660;</span>
        </div>
        <div class="filter-content" id="filterContent">
          <!-- Пример размещения опций по две колонки -->
          <div>
            <input type="checkbox" id="shortenMarkers" data-option="shortenMarkers">
            <label for="shortenMarkers">Сокращать маркеры</label>
          </div>
          <div>
            <input type="checkbox" id="showWinningSideName" data-option="showWinningSideName">
            <label for="showWinningSideName">Победители: сторона</label>
          </div>
          <div>
            <input type="checkbox" id="showWinningHP" data-option="showWinningHP">
            <label for="showWinningHP">Победители: ХП</label>
          </div>
          <div>
            <input type="checkbox" id="showWinningPercent" data-option="showWinningPercent">
            <label for="showWinningPercent">Победители: % выживших</label>
          </div>
          <div>
            <input type="checkbox" id="showWinningFaction" data-option="showWinningFaction">
            <label for="showWinningFaction">Победители: фракция</label>
          </div>
          <div>
            <input type="checkbox" id="showWinningHeroInfo" data-option="showWinningHeroInfo">
            <label for="showWinningHeroInfo">Победители: герои</label>
          </div>
          <div>
            <input type="checkbox" id="showLosingSideName" data-option="showLosingSideName">
            <label for="showLosingSideName">Проигравшие: сторона</label>
          </div>
          <div>
            <input type="checkbox" id="showLosingHP" data-option="showLosingHP">
            <label for="showLosingHP">Проигравшие: ХП</label>
          </div>
          <div>
            <input type="checkbox" id="showLosingPercent" data-option="showLosingPercent">
            <label for="showLosingPercent">Проигравшие: % выживших</label>
          </div>
          <div>
            <input type="checkbox" id="showLosingFaction" data-option="showLosingFaction">
            <label for="showLosingFaction">Проигравшие: фракция</label>
          </div>
          <div>
            <input type="checkbox" id="showLosingHeroInfo" data-option="showLosingHeroInfo">
            <label for="showLosingHeroInfo">Проигравшие: герои</label>
          </div>
        </div>
      </div>
      
      <!-- Текстовое поле ввода -->
      <textarea id="inputText" placeholder="Вставьте сюда текст с ссылками на бои..."></textarea>
      <!-- Кнопка анализа -->
      <button id="analyzeButton">Анализировать ссылки</button>
      <!-- Вывод статуса -->
      <div id="statusDisplay"></div>
    </div>
    
    <!-- Правая панель: вывод результата -->
    <div class="right-panel">
      <textarea id="outputArea" placeholder="Здесь появится модифицированный текст..."></textarea>
    </div>
  </div>
  
  <script>
    /* Инициализация настроек фильтра */
    const defaultFilterOptions = {
      shortenMarkers: true,
      showWinningSideName: true,
      showWinningHP: true,
      showWinningPercent: true,
      showWinningFaction: true,
      showWinningHeroInfo: true,
      showLosingSideName: true,
      showLosingHP: true,
      showLosingPercent: true,
      showLosingFaction: true,
      showLosingHeroInfo: true
    };
    function loadFilterOptions() {
      let stored = localStorage.getItem("battleFilterOptions");
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          return Object.assign({}, defaultFilterOptions);
        }
      }
      return Object.assign({}, defaultFilterOptions);
    }
    function saveFilterOptions(options) {
      localStorage.setItem("battleFilterOptions", JSON.stringify(options));
    }
    let filterOptions = loadFilterOptions();
    
    // Установка значений чекбоксов по сохранённым опциям
    document.querySelectorAll(".filter-content input[type=checkbox]").forEach(cb => {
      let option = cb.getAttribute("data-option");
      cb.checked = !!filterOptions[option];
      cb.addEventListener("change", function() {
        filterOptions[option] = this.checked;
        saveFilterOptions(filterOptions);
        updateFilteredOutput();
      });
    });
    
    // Глобальная переменная для хранения исходного вывода (без фильтрации)
    let originalOutput = "";
    
    // Функция для извлечения ссылок
    function extractBattleLinks(text) {
      let regex = /https:\/\/www\.heroeswm\.ru\/war\.php\?warid=\d+/g;
      let links = text.match(regex) || [];
      return [...new Set(links)];
    }
    
    // Пример трансформации строки результата (реализуйте свою логику при необходимости)
    function transformLine(line, opts) {
      let trimmed = line.trim();
      let firstBracket = trimmed.indexOf("[");
      if (firstBracket > 0) {
        trimmed = trimmed.slice(firstBracket);
      }
      if (!trimmed.startsWith("[")) return line;
      let inner = trimmed.substring(1, trimmed.length - 1);
      let blocks = inner.split("] [");
      let marker = blocks[0];
      let isWinner = (marker.toLowerCase().includes("win") || marker.indexOf("+") !== -1);
      let isLoser = (marker.toLowerCase().includes("lose") || marker.indexOf("-") !== -1);
    
      if (isWinner || isLoser) {
        if (opts.shortenMarkers) {
          blocks[0] = isWinner ? "+" : "-";
        }
      }
      if ((isWinner && !opts.showWinningSideName) || (!isWinner && !opts.showLosingSideName)) {
        blocks[1] = "";
      }
      if ((isWinner && !opts.showWinningHP) || (!isWinner && !opts.showLosingHP)) {
        blocks[2] = "";
      }
      if ((isWinner && !opts.showWinningPercent) || (!isWinner && !opts.showLosingPercent)) {
        blocks[3] = "";
      }
      if ((isWinner && !opts.showWinningFaction) || (!isWinner && !opts.showLosingFaction)) {
        blocks[4] = "";
      }
      return blocks.filter(b => b !== "").map(b => "[" + b + "]").join(" ");
    }
    
    function transformTokensText(inputText, opts) {
      let lines = inputText.split("\n");
      let transformed = lines.map(line => transformLine(line, opts));
      return transformed.join("\n");
    }
    
    function updateFilteredOutput() {
      if (!originalOutput) return;
      let newText = transformTokensText(originalOutput, filterOptions);
      document.getElementById("outputArea").value = newText;
    }
    
    /* Обработчик анализа ссылок */
    document.getElementById("analyzeButton").addEventListener("click", async () => {
      let inputText = document.getElementById("inputText").value;
      let links = extractBattleLinks(inputText);
      let statusDisplay = document.getElementById("statusDisplay");
      
      if (links.length === 0) {
        statusDisplay.textContent = "Ссылки не найдены.";
        return;
      }
      
      statusDisplay.textContent = `Найдено ${links.length} ссылок. Отправляем бои на анализ...`;
      
      async function callAnalyze(linksArray) {
        let response = await fetch("/.netlify/functions/analyzeBattles", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ links: linksArray })
        });
        return response.json();
      }
      
      let remainingLinks = links;
      let finalResults = [];
      let retryRound = 1;
      let secondsElapsed = 0;
      let intervalId = setInterval(() => {
        secondsElapsed++;
        statusDisplay.textContent = `Ждём ${secondsElapsed} сек... (Попытка ${retryRound}. Осталось анализировать ${remainingLinks.length} ссылок)`;
      }, 1000);
      
      while (remainingLinks.length > 0) {
        statusDisplay.textContent += `; Попытка ${retryRound}, отправляем ${remainingLinks.length} ссылок...`;
        let result = await callAnalyze(remainingLinks);
        let errorLinks = [];
        result.results.forEach(r => {
          if (r.status === "success") {
            finalResults.push(r);
          } else {
            errorLinks.push(r.link);
          }
        });
        remainingLinks = errorLinks;
        if (remainingLinks.length > 0) {
          statusDisplay.textContent += `; Повторная отправка для ${remainingLinks.length} ссылок.`;
        }
        retryRound++;
      }
      
      clearInterval(intervalId);
      statusDisplay.textContent = `Анализ завершён. Всего успешно: ${finalResults.length}.`;
      
      // Формируем исходный вывод: каждая ссылка отделена от результата переводом строки
      originalOutput = "";
      finalResults.forEach(r => {
        let analysisStr = r.result ? r.result : "Ошибка анализа";
        originalOutput += `${r.link}:\n${analysisStr}\n`;
      });
      
      updateFilteredOutput();
    });
    
    /* Функция для сворачивания/разворачивания блока фильтра */
    let filterToggle = document.getElementById("filterToggle");
    let filterContent = document.getElementById("filterContent");
    let toggleIcon = document.getElementById("toggleIcon");
    filterToggle.addEventListener("click", () => {
      if (filterContent.classList.contains("collapsed")) {
        filterContent.classList.remove("collapsed");
        toggleIcon.innerHTML = "&#9660;";
      } else {
        filterContent.classList.add("collapsed");
        toggleIcon.innerHTML = "&#9654;";
      }
    });
  </script>
</body>
</html>
