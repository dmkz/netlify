<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Анализ ссылок на бои с фильтрацией (2025)</title>
  <style>
    /* Базовый сброс стилей */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      height: 100vh;
      overflow: hidden;
    }
    /* Контейнер, делящий страницу на две половины */
    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }
    /* Левая панель */
    .left-panel {
      width: 50%;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-right: 2px solid #ddd;
    }
    /* Правая панель */
    .right-panel {
      width: 50%;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #fafafa;
    }
    /* Текстовые поля */
    textarea {
      width: 100%;
      resize: none;
      padding: 8px;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Поле ввода занимает оставшуюся высоту левой панели */
    #inputText {
      flex: 1;
      margin-bottom: 8px;
    }
    /* Область вывода результата */
    #outputArea {
      flex: 1;
    }
    /* Кнопка "Анализировать ссылки" */
    #analyzeButton {
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background-color 0.2s ease-in-out;
    }
    #analyzeButton:hover {
      background-color: #0056b3;
    }
    /* Статус анализа */
    #statusDisplay {
      margin-bottom: 8px;
      font-size: 14px;
    }
    /* Сворачиваемый блок фильтрации */
    .filter-container {
      background: rgba(240, 230, 210, 0.9);
      border: 2px solid #8b4513;
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }
    .filter-header {
      background: #deb887;
      padding: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .filter-header:hover {
      background: #d2a679;
    }
    /* Контент фильтров, оформленный через grid */
    .filter-content {
      padding: 8px;
    }
    .filter-group {
      margin-bottom: 8px;
    }
    .filter-group > .group-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .filter-group .group-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .filter-group label {
      font-size: 14px;
    }
    .filter-group input[type="checkbox"] {
      margin-right: 4px;
    }
    /* Состояние свёрнутого блока */
    .collapsed {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      border: none;
    }
    /* Современные тени */
    .left-panel, .right-panel, .filter-container {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Левая панель -->
    <div class="left-panel">
      <!-- Сворачиваемый блок фильтрации -->
      <div class="filter-container" id="filterContainer">
        <div class="filter-header" id="filterToggle">
          Фильтры <span id="toggleIcon">&#9660;</span>
        </div>
        <div class="filter-content" id="filterContent">
          <!-- Общие опции -->
          <div class="filter-group">
            <div class="group-title">Общие опции</div>
            <div class="group-content">
              <div>
                <input type="checkbox" id="shortenMarkers" data-option="shortenMarkers">
                <label for="shortenMarkers">Сокращать маркеры</label>
              </div>
            </div>
          </div>
          <!-- Опции для победителей -->
          <div class="filter-group">
            <div class="group-title">Победители</div>
            <div class="group-content">
              <div>
                <input type="checkbox" id="showWinningSideName" data-option="showWinningSideName">
                <label for="showWinningSideName">Название стороны</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningHP" data-option="showWinningHP">
                <label for="showWinningHP">Суммарное ХП</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningPercent" data-option="showWinningPercent">
                <label for="showWinningPercent">% выживших</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningFaction" data-option="showWinningFaction">
                <label for="showWinningFaction">Фракция</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningHeroInfo" data-option="showWinningHeroInfo">
                <label for="showWinningHeroInfo">Информация о героях</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningHeroNickname" data-option="showWinningHeroNickname">
                <label for="showWinningHeroNickname">Никнейм героев</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningHeroLevel" data-option="showWinningHeroLevel">
                <label for="showWinningHeroLevel">Уровень героев</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningHeroParams" data-option="showWinningHeroParams">
                <label for="showWinningHeroParams">Параметры героев</label>
              </div>
              <div>
                <input type="checkbox" id="shortenWinningHeroParams" data-option="shortenWinningHeroParams">
                <label for="shortenWinningHeroParams">Сокращать параметры героев</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningArmy" data-option="showWinningArmy">
                <label for="showWinningArmy">Армия</label>
              </div>
              <div>
                <input type="checkbox" id="showWinningBonuses" data-option="showWinningBonuses">
                <label for="showWinningBonuses">Бонусы</label>
              </div>
            </div>
          </div>
          <!-- Опции для проигравших -->
          <div class="filter-group">
            <div class="group-title">Проигравшие</div>
            <div class="group-content">
              <div>
                <input type="checkbox" id="showLosingSideName" data-option="showLosingSideName">
                <label for="showLosingSideName">Название стороны</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingHP" data-option="showLosingHP">
                <label for="showLosingHP">Суммарное ХП</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingPercent" data-option="showLosingPercent">
                <label for="showLosingPercent">% выживших</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingFaction" data-option="showLosingFaction">
                <label for="showLosingFaction">Фракция</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingHeroInfo" data-option="showLosingHeroInfo">
                <label for="showLosingHeroInfo">Информация о героях</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingHeroNickname" data-option="showLosingHeroNickname">
                <label for="showLosingHeroNickname">Никнейм героев</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingHeroLevel" data-option="showLosingHeroLevel">
                <label for="showLosingHeroLevel">Уровень героев</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingHeroParams" data-option="showLosingHeroParams">
                <label for="showLosingHeroParams">Параметры героев</label>
              </div>
              <div>
                <input type="checkbox" id="shortenLosingHeroParams" data-option="shortenLosingHeroParams">
                <label for="shortenLosingHeroParams">Сокращать параметры героев</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingArmy" data-option="showLosingArmy">
                <label for="showLosingArmy">Армия</label>
              </div>
              <div>
                <input type="checkbox" id="showLosingBonuses" data-option="showLosingBonuses">
                <label for="showLosingBonuses">Бонусы</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Текстовое поле ввода -->
      <textarea id="inputText" placeholder="Вставьте сюда текст с ссылками на бои..."></textarea>
      <!-- Кнопка анализа -->
      <button id="analyzeButton">Анализировать ссылки</button>
      <!-- Статус -->
      <div id="statusDisplay"></div>
    </div>
    <!-- Правая панель с результатом -->
    <div class="right-panel">
      <textarea id="outputArea" placeholder="Здесь появится модифицированный текст..."></textarea>
    </div>
  </div>
  
  <script>
    /* --- Инициализация опций фильтрации --- */
    const defaultFilterOptions = {
      shortenMarkers: true,
      showWinningSideName: true,
      showLosingSideName: true,
      showWinningHP: true,
      showLosingHP: true,
      showWinningPercent: true,
      showLosingPercent: true,
      showWinningFaction: true,
      showLosingFaction: true,
      showWinningHeroInfo: true,
      showLosingHeroInfo: true,
      showWinningHeroNickname: true,
      showLosingHeroNickname: true,
      showWinningHeroLevel: true,
      showLosingHeroLevel: true,
      showWinningHeroParams: true,
      showLosingHeroParams: true,
      shortenWinningHeroParams: true,
      shortenLosingHeroParams: true,
      showWinningArmy: true,
      showLosingArmy: true,
      showWinningBonuses: true,
      showLosingBonuses: true
    };
    function loadFilterOptions() {
      let stored = localStorage.getItem("battleFilterOptions");
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          return Object.assign({}, defaultFilterOptions);
        }
      }
      return Object.assign({}, defaultFilterOptions);
    }
    function saveFilterOptions(options) {
      localStorage.setItem("battleFilterOptions", JSON.stringify(options));
    }
    let filterOptions = loadFilterOptions();
    
    // Установка состояния чекбоксов в сворачиваемом блоке
    document.querySelectorAll(".filter-content input[type=checkbox]").forEach(cb => {
      let option = cb.getAttribute("data-option");
      cb.checked = !!filterOptions[option];
      cb.addEventListener("change", function() {
        filterOptions[option] = this.checked;
        saveFilterOptions(filterOptions);
        updateFilteredOutput();
      });
    });
    
    /* --- Глобальные переменные --- */
    let originalOutput = "";
    
    /* --- Функция извлечения ссылок --- */
    function extractBattleLinks(text) {
      let regex = /https:\/\/www\.heroeswm\.ru\/war\.php\?warid=\d+/g;
      let links = text.match(regex) || [];
      return [...new Set(links)];
    }
    
    /* --- Пример функции трансформации строки результата --- */
    function transformLine(line, opts) {
      let trimmed = line.trim();
      let firstBracket = trimmed.indexOf("[");
      if (firstBracket > 0) {
        trimmed = trimmed.slice(firstBracket);
      }
      if (!trimmed.startsWith("[")) return line;
      let inner = trimmed.substring(1, trimmed.length - 1);
      let blocks = inner.split("] [");
      let marker = blocks[0];
      let isWinner = (marker.toLowerCase().includes("win") || marker.indexOf("+") !== -1);
      let isLoser = (marker.toLowerCase().includes("lose") || marker.indexOf("-") !== -1);
      
      if (isWinner || isLoser) {
        if (opts.shortenMarkers) {
          blocks[0] = isWinner ? "+" : "-";
        }
      }
      if ((isWinner && !opts.showWinningSideName) || (!isWinner && !opts.showLosingSideName)) {
        blocks[1] = "";
      }
      if ((isWinner && !opts.showWinningHP) || (!isWinner && !opts.showLosingHP)) {
        blocks[2] = "";
      }
      if ((isWinner && !opts.showWinningPercent) || (!isWinner && !opts.showLosingPercent)) {
        blocks[3] = "";
      }
      if ((isWinner && !opts.showWinningFaction) || (!isWinner && !opts.showLosingFaction)) {
        blocks[4] = "";
      }
      // Дополнительную обработку для информации о героях, армии и бонусах можно добавить по необходимости
      return blocks.filter(b => b !== "").map(b => "[" + b + "]").join(" ");
    }
    
    function transformTokensText(inputText, opts) {
      let lines = inputText.split("\n");
      let transformed = lines.map(line => transformLine(line, opts));
      return transformed.join("\n");
    }
    
    function updateFilteredOutput() {
      if (!originalOutput) return;
      let newText = transformTokensText(originalOutput, filterOptions);
      document.getElementById("outputArea").value = newText;
    }
    
    /* --- Обработчик анализа ссылок --- */
    document.getElementById("analyzeButton").addEventListener("click", async () => {
      let inputText = document.getElementById("inputText").value;
      let links = extractBattleLinks(inputText);
      let statusDisplay = document.getElementById("statusDisplay");
      
      if (links.length === 0) {
        statusDisplay.textContent = "Ссылки не найдены.";
        return;
      }
      
      statusDisplay.textContent = `Найдено ${links.length} ссылок. Отправляем бои на анализ...`;
      
      async function callAnalyze(linksArray) {
        let response = await fetch("/.netlify/functions/analyzeBattles", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ links: linksArray })
        });
        return response.json();
      }
      
      let remainingLinks = links;
      let finalResults = [];
      let retryRound = 1;
      let secondsElapsed = 0;
      let intervalId = setInterval(() => {
        secondsElapsed++;
        statusDisplay.textContent = `Ждём ${secondsElapsed} сек... (Попытка ${retryRound}. Осталось анализировать ${remainingLinks.length} ссылок)`;
      }, 1000);
      
      while (remainingLinks.length > 0) {
        statusDisplay.textContent += `; Попытка ${retryRound}, отправляем ${remainingLinks.length} ссылок...`;
        let result = await callAnalyze(remainingLinks);
        let errorLinks = [];
        result.results.forEach(r => {
          if (r.status === "success") {
            finalResults.push(r);
          } else {
            errorLinks.push(r.link);
          }
        });
        remainingLinks = errorLinks;
        if (remainingLinks.length > 0) {
          statusDisplay.textContent += `; Повторная отправка для ${remainingLinks.length} ссылок.`;
        }
        retryRound++;
      }
      
      clearInterval(intervalId);
      statusDisplay.textContent = `Анализ завершён. Всего успешно: ${finalResults.length}.`;
      
      // Формируем исходный вывод: каждая ссылка отделена от результата переводом строки
      originalOutput = "";
      finalResults.forEach(r => {
        let analysisStr = r.result ? r.result : "Ошибка анализа";
        originalOutput += `${r.link}:\n${analysisStr}\n`;
      });
      
      updateFilteredOutput();
    });
    
    /* --- Сворачивание/разворачивание блока фильтрации --- */
    let filterToggle = document.getElementById("filterToggle");
    let filterContent = document.getElementById("filterContent");
    let toggleIcon = document.getElementById("toggleIcon");
    filterToggle.addEventListener("click", () => {
      if (filterContent.classList.contains("collapsed")) {
        filterContent.classList.remove("collapsed");
        toggleIcon.innerHTML = "&#9660;";
      } else {
        filterContent.classList.add("collapsed");
        toggleIcon.innerHTML = "&#9654;";
      }
    });
  </script>
</body>
</html>
